<!DOCTYPE html>
<html lang="pl">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ff6b6b">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#059669" />
  <title>Recipe app by Leon Tyra≈Ça</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary-color: #059669;
      --secondary-color: #10b981;
      --accent-color: #34d399;
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-color: #ffffff;
      --border-color: #334155;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }
    
    .light-mode {
      --primary-color: #059669;
      --secondary-color: #10b981;
      --accent-color: #047857;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-color: #1e293b;
      --border-color: #e2e8f0;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    .light-mode .form-input,
    .light-mode .form-select,
    .light-mode .form-textarea,
    .light-mode .search-bar {
      background: #ffffff !important;
      color: #1e293b !important;
      border: 1px solid #e2e8f0 !important;
    }
    
    .light-mode .btn {
      color: #ffffff !important;
    }
    
    .light-mode .card {
      background: #ffffff !important;
      color: #1e293b !important;
    }
    
    .light-mode .section-title,
    .light-mode .recipe-card h3,
    .light-mode .ingredient-card h3 {
      color: #1e293b !important;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
      padding-bottom: 80px;
      transition: all 0.3s ease;
    }
    
    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
      border-bottom: 1px solid var(--border-color);
    }
    
    .light-mode .header {
      background: rgba(248, 250, 252, 0.95);
    }
    
    .logo {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--secondary-color);
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .header-btn, .theme-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .header-btn:hover, .theme-toggle:hover {
      background: var(--primary-color);
      color: white;
    }
    
    /* Main Content */
    .main-content {
      margin-top: 70px;
      padding: 20px;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .section-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--text-color);
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px var(--shadow-color);
    }
    
    .recipe-card {
      cursor: pointer;
    }
    
    .recipe-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-color);
    }
    
    .recipe-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .recipe-info {
      flex: 1;
    }
    
    .recipe-info h3 {
      color: var(--text-color);
      margin-bottom: 4px;
    }
    
    .recipe-icon {
      font-size: 1.5rem;
      margin-right: 12px;
    }
    
    .meta-tag {
      background: rgba(16, 185, 129, 0.2);
      color: var(--secondary-color);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-right: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 4px;
    }
    
    .btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
    }
    
    .btn-secondary {
      background: rgba(107, 114, 128, 0.8);
      color: white;
    }
    
    .btn-secondary:hover {
      background: rgba(107, 114, 128, 1);
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .form-input, .form-select, .form-textarea {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 0.9rem;
    }
    
    .search-bar {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .light-mode .search-bar {
      background: #ffffff !important;
      color: #1e293b !important;
      border: 1px solid #d1d5db !important;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      z-index: 1000;
    }
    
    .light-mode .bottom-nav {
      background: rgba(248, 250, 252, 0.95);
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      color: #64748b;
      min-width: 60px;
    }
    
    .nav-item.active {
      color: var(--secondary-color);
      background: rgba(16, 185, 129, 0.1);
    }
    
    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }
    
    .nav-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* FAB */
    .fab {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    
    .fab:hover {
      transform: scale(1.1);
      background: var(--secondary-color);
    }
    
    /* Ingredients */
    .ingredient-item {
      display: grid;
      grid-template-columns: 2fr 1fr 80px 40px;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .remove-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .ingredient-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
    }
    
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s ease;
    }
    
    .suggestion-item:hover {
      background: rgba(16, 185, 129, 0.1);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .allergen-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .allergen-tag {
      background: rgba(107, 114, 128, 0.2);
      color: var(--text-color);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid rgba(107, 114, 128, 0.3);
      transition: all 0.3s ease;
    }
    
    .allergen-tag:hover {
      background: rgba(107, 114, 128, 0.3);
    }
    
    .allergen-tag.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .cost-summary {
      background: rgba(5, 150, 105, 0.1);
      border: 1px solid rgba(5, 150, 105, 0.2);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .cost-line {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(5, 150, 105, 0.1);
    }
    
    .cost-line:last-child {
      border-bottom: none;
      font-weight: 600;
      margin-top: 8px;
      padding-top: 12px;
      border-top: 2px solid rgba(5, 150, 105, 0.3);
    }
    
    .ingredient-category {
      background: var(--primary-color);
      color: white;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.9rem;
      margin: 16px 0 8px 0;
      border-radius: 6px;
    }
    
    .ingredient-db-item {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .ingredient-db-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }
    
    .stat-card {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--secondary-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--secondary-color);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--text-color);
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
/* TRYB PRO - KOMPLETNA METAMORFOZA */
body.pro-mode {
  background: #ffffff !important;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
  font-size: 11px !important;
  line-height: 1.2 !important;
}

/* Ukryj standardowe sekcje w trybie Pro */
body.pro-mode .section:not(.pro-section) {
  display: none !important;
}

body.pro-mode .bottom-nav {
  display: none !important;
}

/* Poka≈º tylko Pro interfejs */
body.pro-mode .pro-interface {
  display: block !important;
}

body:not(.pro-mode) .pro-interface {
  display: none !important;
}

/* Style dla Pro interfejsu */
.pro-interface {
  width: 100%;
  height: 100vh;
  background: #ffffff;
  border: 2px solid #000000;
}

.pro-header {
  background: #e9ecef;
  border-bottom: 2px solid #000000;
  padding: 8px 12px;
  font-weight: bold;
  font-size: 12px;
}

.pro-tabs {
  background: #f8f9fa;
  border-bottom: 1px solid #666666;
  padding: 2px;
}

.pro-tab {
  background: #ffffff;
  border: 1px solid #666666;
  border-bottom: none;
  padding: 6px 12px;
  margin-right: 2px;
  font-size: 10px;
  font-weight: bold;
  cursor: pointer;
}

.pro-tab.active {
  background: #ffffff;
  border-top: 3px solid #0066cc;
}

.pro-content {
  padding: 10px;
  height: calc(100vh - 100px);
  overflow: auto;
}

.pro-table {
  width: 100%;
  border-collapse: collapse;
  border: 2px solid #000000;
  font-size: 10px;
}

.pro-table th {
  background: #e9ecef;
  border: 1px solid #666666;
  padding: 6px 4px;
  text-align: left;
  font-weight: bold;
  font-size: 9px;
  text-transform: uppercase;
}

.pro-table td {
  border: 1px solid #cccccc;
  padding: 4px;
  background: #ffffff;
}

.pro-table tr:nth-child(even) td {
  background: #f8f9fa;
}

.pro-table tr:hover td {
  background: #e3f2fd;
}
/* PRO INTERFACE - WIDOCZNO≈öƒÜ */
.pro-interface {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background: #ffffff !important;
  z-index: 1000 !important;
  border: 5px solid #ff0000 !important;
}

.pro-header {
  background: #000000 !important;
  color: #ffffff !important;
  padding: 15px !important;
  font-size: 16px !important;
  font-weight: bold !important;
}

.pro-tabs {
  background: #cccccc !important;
  padding: 10px !important;
}

.pro-tab {
  background: #ffffff !important;
  border: 2px solid #000000 !important;
  padding: 10px 15px !important;
  margin-right: 5px !important;
  font-weight: bold !important;
}

.pro-content {
  background: #ffffff !important;
  padding: 20px !important;
  color: #000000 !important;
  font-size: 14px !important;
}

body:not(.pro-mode) .pro-interface {
  display: none !important;
}

body.pro-mode .pro-interface {
  display: block !important;
}
    
    @media (max-width: 768px) {
      .ingredient-item {
        grid-template-columns: 1fr;
        gap: 4px;
      }
      
      .header-actions span {
        display: none;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
	  /* OPTYMALIZACJA MOBILNA */
@media (max-width: 768px) {
  
  /* G≈Å√ìWNY KONTENER */
  .container {
    padding: 10px !important;
    margin: 0 !important;
  }
  
  /* NAG≈Å√ìWEK */
  .header {
    padding: 10px !important;
    font-size: 16px !important;
  }
  
  /* PRZYCISKI */
  button {
    min-height: 44px !important;
    font-size: 16px !important;
    padding: 12px 15px !important;
    margin: 5px 2px !important;
  }
  
  /* POLA TEKSTOWE */
  input, textarea, select {
    min-height: 44px !important;
    font-size: 16px !important;
    padding: 12px !important;
    border-radius: 8px !important;
  }
  
  /* KARTY PRZEPIS√ìW */
  .recipe-card {
    margin: 10px 0 !important;
    padding: 15px !important;
    font-size: 14px !important;
  }
  
  /* SIATKA SK≈ÅADNIK√ìW */
  .ingredients-grid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  /* TABELE - STACK VERTICALLY */
  .pro-table {
    display: block !important;
  }
  
  .pro-table > div {
    display: block !important;
    border-bottom: 1px solid #ddd !important;
    padding: 10px !important;
  }
  
  /* UKRYJ MNIEJSZE ELEMENTY */
  .desktop-only {
    display: none !important;
  }
  
  /* PE≈ÅNA SZEROKO≈öƒÜ NA MOBILE */
  .mobile-full-width {
    width: 100% !important;
    box-sizing: border-box !important;
  }
  
  /* WIƒòKSZE KLIKNIƒòCIA */
  .clickable {
    min-height: 44px !important;
    min-width: 44px !important;
  }
  
  /* SCROLL CONTAINERS */
  .scroll-container {
    max-height: 60vh !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
}

/* TOUCH IMPROVEMENTS */
* {
  -webkit-tap-highlight-color: rgba(0,0,0,0.1);
  -webkit-touch-callout: none;
}

/* PREVENT ZOOM ON INPUT FOCUS */
input, select, textarea {
  font-size: 16px !important;
}
.volume-calculator {
    padding: 20px;
}
.shape-card, .comparison-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}
.shape-card h5, .comparison-card h5 {
    color: #007bff;
    margin-bottom: 15px;
}
.result-box {
    background: #e8f5e8;
    border: 1px solid #28a745;
    border-radius: 5px;
    padding: 10px;
    margin-top: 15px;
    text-align: center;
}
.comparison-results {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 5px;
    padding: 15px;
    margin-top: 15px;
}
.comparison-results div {
    margin-bottom: 5px;
}
	  
    }
	
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">Recipe app by Leon Tyra≈Ça</div>
    <div class="header-actions">
      <span id="totalRecipes">0 przepis√≥w</span>
      <span id="totalIngredients">0 sk≈Çadnik√≥w</span>
     <button class="header-btn" onclick="showSection('settings')" title="Ustawienia">‚öôÔ∏è</button>
<button class="header-btn" onclick="refreshData()" title="Od≈õwie≈º dane">üîÑ</button>
<button class="header-btn" onclick="exportData()" title="Eksportuj dane">üíæ</button>
<button class="theme-toggle" onclick="toggleTheme()" title="Zmie≈Ñ motyw">‚òÄÔ∏è</button>
<button onclick="toggleProMode()" class="pro-toggle" id="proToggle">
  üìä
</button>
    </div>
  </header>

  <main class="main-content">
    <!-- Przepisy -->
    <section id="recipes" class="section active">
      <h2 class="section-title">Przepisy</h2>
      <input type="text" class="search-bar" placeholder="Szukaj po nazwie, sk≈Çadnikach, kategorii..." oninput="searchRecipes(this.value)" />
      <div id="recipesList"></div>
    </section>

    <!-- Dodawanie przepisu -->
    <section id="add-recipe" class="section">
      <h2 class="section-title">Dodaj przepis</h2>
      
      <div class="card">
        <div class="form-group">
          <label class="form-label">Nazwa przepisu</label>
          <input type="text" class="form-input" id="recipeName" placeholder="np. Sernik klasyczny" />
        </div>
        
        <div class="form-group">
          <label class="form-label">Kategoria</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select class="form-select" id="recipeCategory" style="flex: 1;">
              <option value="">Wybierz kategoriƒô...</option>
            </select>
            <button class="btn btn-secondary btn-small" onclick="showAddCategory()">+</button>
          </div>
		  <div class="form-group">
  <label class="form-label">üè∑Ô∏è Oznaczenia dietetyczne</label>
  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
    
    <label style="display: flex; align-items: center; cursor: pointer; background: rgba(40, 167, 69, 0.1); padding: 6px 10px; border-radius: 15px; border: 1px solid #28a745; font-size: 12px;">
      <input type="checkbox" id="vegan" style="margin-right: 6px;">
      <span style="color: #28a745;">üå± Wega≈Ñski</span>
    </label>
    
    <label style="display: flex; align-items: center; cursor: pointer; background: rgba(0, 123, 255, 0.1); padding: 6px 10px; border-radius: 15px; border: 1px solid #007bff; font-size: 12px;">
      <input type="checkbox" id="lactose-free" style="margin-right: 6px;">
      <span style="color: #007bff;">ü•õ Bez laktozy</span>
    </label>
    
    <label style="display: flex; align-items: center; cursor: pointer; background: rgba(255, 193, 7, 0.1); padding: 6px 10px; border-radius: 15px; border: 1px solid #ffc107; font-size: 12px;">
      <input type="checkbox" id="gluten-free" style="margin-right: 6px;">
      <span style="color: #f57c00;">üåæ Bez glutenu</span>
    </label>
    
  </div>
</div>
          
          <div id="addCategoryForm" style="display: none; margin-top: 8px; padding: 12px; background: rgba(5, 150, 105, 0.1); border-radius: 6px;">
            <input type="text" class="form-input" id="newCategoryName" placeholder="Nazwa nowej kategorii" style="margin-bottom: 8px;" />
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-small" onclick="cancelAddCategory()">Anuluj</button>
              <button class="btn btn-small" onclick="saveNewCategory()">Dodaj</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Opis</label>
          <textarea class="form-textarea" id="recipeDescription" placeholder="Kr√≥tki opis przepisu..." rows="3"></textarea>
        </div>
        
        <div class="form-group" style="display: none;">
          <label class="form-label">Porcje (opcjonalne)</label>
          <input type="number" class="form-input" id="recipeServings" placeholder="1" min="1" value="1" />
          <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 4px;">Mo≈ºna pominƒÖƒá - kalkulator liczy wed≈Çug wagi</div>
        </div>
        

      </div>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 12px;">ü•ò Sk≈Çadniki</h3>
        <div id="ingredientsList">
          <div class="ingredient-item">
            <div style="position: relative; flex: 2;">
              <input type="text" class="form-input ingredient-input" placeholder="Wpisz sk≈Çadnik..." 
                     oninput="showIngredientSuggestions(this)" 
                     onfocus="showIngredientSuggestions(this)"
                     onblur="hideIngredientSuggestions(this)" />
              <div class="ingredient-suggestions" style="display: none;"></div>
            </div>
            <input type="number" class="form-input amount-input" placeholder="Ilo≈õƒá" step="0.01" oninput="calculateRecipeCostLive()" />
            <select class="form-select unit-select" onchange="calculateRecipeCostLive()">
              <option value="kg">kg</option>
              <option value="g">g</option>
              <option value="l">l</option>
              <option value="ml">ml</option>
              <option value="szt">szt</option>
            </select>
            <button class="remove-btn" onclick="removeIngredient(this)">üóëÔ∏è</button>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="addIngredientRow()">+ Dodaj sk≈Çadnik</button>
        
        <div id="costCalculation" class="cost-summary" style="display: none;">
          <h3 style="color: var(--secondary-color); margin-bottom: 12px;">üí∞ Kalkulacja koszt√≥w</h3>
          <div id="costBreakdown"></div>
          <div id="ingredientPercentages" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(5, 150, 105, 0.3);">
            <h4 style="color: var(--secondary-color); margin-bottom: 8px;">üìä Udzia≈Ç sk≈Çadnik√≥w</h4>
            <div id="percentageBreakdown"></div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 12px;">‚ö†Ô∏è Alergeny</h3>
        <div class="allergen-selection">
          <div class="allergen-tag" onclick="toggleAllergen(this)" data-allergen="gluten">Gluten</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'mleko')">Mleko</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'jajka')">Jajka</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'orzechy')">Orzechy</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'orzechyziemne')">Orzech ziemny</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'soja')">Soja</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'sezam')">Sezam</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'dwutleneksiarki')">Dwutlenek siarki</div>
          <div class="allergen-tag" onclick="toggleAllergen(this, 'lubin')">≈Åubin</div>
        </div>
      </div>
      
      <div class="card">
        <div class="form-group">
          <label class="form-label">Wydajno≈õƒá (%)</label>
          <input type="number" class="form-input" id="recipeYield" placeholder="95" min="70" max="100" value="95" oninput="calculateRecipeCostLive()" />
          <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 4px;">Uwzglƒôdnia straty (miski, odparowanie)</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Instrukcje</label>
          <textarea class="form-textarea" id="recipeInstructions" placeholder="1. Krok pierwszy...&#10;2. Krok drugi..." rows="5"></textarea>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn" onclick="saveRecipe()" style="padding: 12px 24px;">üíæ Zapisz przepis</button>
        <button class="btn btn-secondary" onclick="clearRecipeForm()" style="padding: 12px 24px;">üóëÔ∏è Wyczy≈õƒá</button>
      </div>
    </section>

    <!-- Kalkulator -->
    <section id="calculator" class="section">
      <h2 class="section-title">Kalkulator produkcji</h2>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 16px;">üîç Wybierz przepis</h3>
        <div style="position: relative;">
          <input type="text" class="search-bar" id="recipeSearch" placeholder="Wpisz nazwƒô przepisu..." oninput="searchRecipesForCalculator()" />
          <div id="recipeSearchResults" style="
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
          "></div>
        </div>
        
        <div id="selectedRecipeInfo" style="display: none; margin-top: 16px; padding: 16px; background: rgba(5, 150, 105, 0.1); border-radius: 8px; border: 1px solid rgba(5, 150, 105, 0.2);">
          <h4 style="color: var(--secondary-color); margin-bottom: 8px;">Wybrany przepis:</h4>
          <div id="selectedRecipeName"></div>
          <div id="selectedRecipeDetails" style="font-size: 0.85rem; opacity: 0.8; margin-top: 4px;"></div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 16px;">‚öñÔ∏è Przelicz na wagƒô</h3>
        <div class="form-group">
          <label class="form-label">Docelowa waga produktu (g)</label>
          <input type="number" class="form-input" id="targetWeightGrams" placeholder="1000" min="1" oninput="calculateByWeightGrams()" />
          <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 4px;">Wprowad≈∫ wagƒô gotowego produktu w gramach</div>
        </div>
        
        <div id="proportionResult" style="display: none;">
          <div style="background: rgba(5, 150, 105, 0.1); border-radius: 8px; padding: 16px; border: 1px solid rgba(5, 150, 105, 0.2); margin-top: 16px;">
            <h4 style="color: var(--secondary-color); margin-bottom: 12px;">üìä Przeliczenie</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div style="text-align: center;">
                <div style="font-size: 0.8rem; opacity: 0.7;">Oryginalna waga</div>
                <div style="font-size: 1.2rem; font-weight: 600;" id="originalWeightDisplay">0g</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 0.8rem; opacity: 0.7;">Docelowa waga</div>
                <div style="font-size: 1.2rem; font-weight: 600;" id="targetWeightDisplay">0g</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 0.8rem; opacity: 0.7;">Mno≈ºnik</div>
                <div style="font-size: 1.2rem; font-weight: 600;" id="multiplierDisplay">√ó1</div>
              </div>
            </div>
            <div id="scaledIngredientsList"></div>
          </div>
          
          <button class="btn" onclick="exportScaledRecipeToPDF()" style="margin-top: 12px;">
            Eksportuj przeliczony przepis do PDF
          </button>
        </div>
      </div>
    </section>
	<li class="nav-item" role="presentation">
    <button class="nav-link" id="volume-tab" data-bs-toggle="tab" data-bs-target="#volume" type="button">
        üìê Objƒôto≈õƒá Form
    </button>
</li>
<!-- Dodaj do tab-content -->
<div class="tab-pane fade" id="volume" role="tabpanel">
    <div class="volume-calculator">
        <h4>üßÆ Kalkulator Objƒôto≈õci Form</h4>
        
        <div class="form-shapes">
            <!-- FORMA OKRƒÑG≈ÅA -->
            <div class="shape-card">
                <h5>üîµ Forma OkrƒÖg≈Ça</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label>≈örednica (cm):</label>
                        <input type="number" id="circle-diameter" class="form-control" placeholder="np. 20" step="0.1">
                    </div>
                    <div class="col-md-6">
                        <label>Wysoko≈õƒá (cm):</label>
                        <input type="number" id="circle-height" class="form-control" placeholder="np. 5" step="0.1">
                    </div>
                </div>
                <div class="result-box">
                    <strong>Objƒôto≈õƒá: <span id="circle-result">0 ml</span></strong>
                </div>
            </div>
            <!-- FORMA PROSTOKƒÑTNA -->
            <div class="shape-card">
                <h5>‚¨ú Forma ProstokƒÖtna</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label>D≈Çugo≈õƒá (cm):</label>
                        <input type="number" id="rect-length" class="form-control" placeholder="np. 25" step="0.1">
                    </div>
                    <div class="col-md-4">
                        <label>Szeroko≈õƒá (cm):</label>
                        <input type="number" id="rect-width" class="form-control" placeholder="np. 15" step="0.1">
                    </div>
                    <div class="col-md-4">
                        <label>Wysoko≈õƒá (cm):</label>
                        <input type="number" id="rect-height" class="form-control" placeholder="np. 5" step="0.1">
                    </div>
                </div>
                <div class="result-box">
                    <strong>Objƒôto≈õƒá: <span id="rect-result">0 ml</span></strong>
                </div>
            </div>
            <!-- FORMA KWADRATOWA -->
            <div class="shape-card">
                <h5>‚¨õ Forma Kwadratowa</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label>Bok (cm):</label>
                        <input type="number" id="square-side" class="form-control" placeholder="np. 20" step="0.1">
                    </div>
                    <div class="col-md-6">
                        <label>Wysoko≈õƒá (cm):</label>
                        <input type="number" id="square-height" class="form-control" placeholder="np. 5" step="0.1">
                    </div>
                </div>
                <div class="result-box">
                    <strong>Objƒôto≈õƒá: <span id="square-result">0 ml</span></strong>
                </div>
            </div>
            <!-- POR√ìWNANIE FORM -->
            <div class="comparison-card">
                <h5>üìä Por√≥wnanie z FormƒÖ BazowƒÖ</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label>Forma bazowa (≈õrednica cm):</label>
                        <input type="number" id="base-diameter" class="form-control" placeholder="np. 24" step="0.1">
                    </div>
                    <div class="col-md-6">
                        <label>Wysoko≈õƒá bazowa (cm):</label>
                        <input type="number" id="base-height" class="form-control" placeholder="np. 6" step="0.1">
                    </div>
                </div>
                <div class="comparison-results">
                    <div><strong>Forma bazowa: <span id="base-volume">0 ml</span></strong></div>
                    <div><strong>R√≥≈ºnica: <span id="volume-difference">0 ml</span></strong></div>
                    <div><strong>Przelicznik: <span id="volume-multiplier">1.0x</span></strong></div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Sk≈Çadniki -->
    <section id="ingredients" class="section">
      <h2 class="section-title">Baza sk≈Çadnik√≥w</h2>
      <input type="text" class="search-bar" placeholder="Szukaj sk≈Çadnik√≥w..." oninput="searchIngredients(this.value)" />
      
      <button class="btn btn-secondary btn-small" onclick="showAddIngredient()" style="margin-bottom: 16px;">Dodaj sk≈Çadnik</button>
	  <div style="margin-bottom: 16px;">
  <button class="btn btn-small" onclick="showAddIngredientCategory()">‚ûï Dodaj kategoriƒô</button>
</div>
<div id="ingredientCategoriesList" style="margin-bottom: 16px;"></div>
<div id="addIngredientCategoryForm" style="display:none; margin-bottom: 16px;">
  <input type="text" class="form-input" id="newIngredientCategoryName" placeholder="Nowa kategoria sk≈Çadnik√≥w" />
  <div style="display: flex; gap: 8px; margin-top: 8px;">
    <button class="btn btn-secondary btn-small" onclick="cancelAddIngredientCategory()">Anuluj</button>
    <button class="btn btn-small" onclick="saveIngredientCategory()">Zapisz</button>
  </div>
</div>

      
      <div id="ingredientsDisplay"></div>
      
      <!-- Formularz dodawania sk≈Çadnika -->
      <div id="addIngredientForm" style="display: none;" class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 16px;">‚ûï Nowy sk≈Çadnik</h3>
		</div>
        
        <div class="form-group">
          <label class="form-label">Nazwa sk≈Çadnika</label>
          <input type="text" class="form-input" id="newIngredientName" placeholder="Np. MƒÖka pszenna" />
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label class="form-label">Cena za kg/litr (z≈Ç)</label>
            <input type="number" class="form-input" id="newIngredientPrice" placeholder="3.20" step="0.01" />
          </div>
          
          <div class="form-group">
            <label class="form-label">Jednostka</label>
            <select class="form-select" id="newIngredientUnit">
              <option value="kg">kg</option>
              <option value="l">l</option>
            </select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label class="form-label">Kategoria</label>
           <div style="display: flex; gap: 8px;">
  <select class="form-select" id="newIngredientCategory" style="flex: 1;">
    <option value="">Wybierz kategoriƒô...</option>
  </select>
  <button class="btn btn-secondary btn-small" onclick="showAddIngredientCategory()">+</button>
</div>
          
          <div class="form-group">
            <label class="form-label">Alergen</label>
            <select class="form-select" id="newIngredientAllergen">
              <option value="">Brak</option>
              <option value="gluten">Gluten</option>
              <option value="mleko">Mleko</option>
              <option value="jajka">Jajka</option>
              <option value="orzechy">Orzechy</option>
              <option value="orzechyziemne">Orzech ziemny</option>
              <option value="soja">Soja</option>
              <option value="ryby">Ryby</option>
              <option value="skorupiaki">Skorupiaki</option>
              <option value="miecczaki">Miƒôczaki</option>
              <option value="seler">Seler</option>
              <option value="gorczyca">Gorczyca</option>
              <option value="sezam">Sezam</option>
              <option value="dwutleneksiarki">Dwutlenek siarki</option>
              <option value="lubin">≈Åubin</option>
            </select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
          <button class="btn btn-secondary" onclick="cancelAddIngredient()">Anuluj</button>
          <button class="btn" onclick="saveNewIngredient()">Zapisz</button>
        </div>
      </div>
    </section>

    <!-- Ustawienia -->
    <section id="settings" class="section">
      <h2 class="section-title">Ustawienia i statystyki</h2>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 12px;">Statystyki</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="statsRecipes">0</div>
            <div class="stat-label">Przepisy</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statsIngredients">0</div>
            <div class="stat-label">Sk≈Çadniki</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statsCategories">0</div>
            <div class="stat-label">Kategorie</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statsAvgCost">0.00 z≈Ç</div>
            <div class="stat-label">≈öredni koszt</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 12px;">Motyw</h3>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button class="btn btn-secondary" onclick="setTheme('dark')">Ciemny</button>
          <button class="btn btn-secondary" onclick="setTheme('light')">Jasny</button>
          <span id="currentTheme">Ciemny</span>
        </div>
      </div>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 12px;">Spis ID przepis√≥w i sk≈Çadnik√≥w</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <button class="btn btn-secondary" onclick="showIdList('recipes')" id="showRecipesBtn">Przepisy</button>
          <button class="btn btn-secondary" onclick="showIdList('ingredients')" id="showIngredientsBtn">Sk≈Çadniki</button>
        </div>
        <div id="idListContainer" style="display: none;">
          <div id="idListContent"></div>
        </div>
      </div>
      
      <div class="card">
        <h3 style="color: var(--secondary-color); margin-bottom: 12px;">ZarzƒÖdzanie danymi</h3>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-secondary" onclick="exportData()">Eksportuj dane</button>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData()" />
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Importuj dane</button>
          <button class="btn" onclick="refreshData()" style="background: var(--secondary-color);">Od≈õwie≈º aplikacjƒô</button>
          <button class="btn" onclick="resetAllData()" style="background: #dc2626;">Wyczy≈õƒá wszystko</button>
        </div>
      </div>
    </section>
  </main>

  <button class="fab" onclick="showSection('add-recipe')" id="fab">‚ûï</button>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showSection('recipes')">
      <div class="nav-icon">üìã</div>
      <div class="nav-label">Przepisy</div>
    </div>
    <div class="nav-item" onclick="showSection('add-recipe')">
      <div class="nav-icon">‚ûï</div>
      <div class="nav-label">Dodaj</div>
    </div>
    <div class="nav-item" onclick="showSection('calculator')">
      <div class="nav-icon">‚öñÔ∏è</div>
      <div class="nav-label">Kalkulator</div>
    </div>
    <div class="nav-item" onclick="showSection('ingredients')">
      <div class="nav-icon">üì¶</div>
      <div class="nav-label">Sk≈Çadniki</div>
    </div>
    <div class="nav-item" onclick="showSection('settings')">
      <div class="nav-icon">‚öôÔ∏è</div>
      <div class="nav-label">Ustawienia</div>
    </div>
  </nav>

  <script> 
  function showAddIngredientCategory() {
  document.getElementById('addIngredientCategoryForm').style.display = 'block';
  document.getElementById('newIngredientCategoryName').focus();
}
function toggleProMode() {
  const body = document.body;
  const button = document.getElementById('proToggle');
  
  if (body.classList.contains('pro-mode')) {
    // TRYB STANDARDOWY
    body.classList.remove('pro-mode');
    button.textContent = 'üìä Tryb Pro';
    localStorage.setItem('bakeryProMode', 'false');
    showNotification('Prze≈ÇƒÖczono na tryb standardowy');
  } else {
    // TRYB PRO
    body.classList.add('pro-mode');
    button.textContent = 'üé® Tryb Standard';
    localStorage.setItem('bakeryProMode', 'true');
    showNotification('Prze≈ÇƒÖczono na tryb Pro');
    
    // Automatyczne ≈Çadowanie przepis√≥w po 100ms
    setTimeout(function() {
      if (document.querySelector('.pro-interface')) {
        showProTab('recipes');
      }
    }, 100);
  }
}

// Wczytaj ustawienie przy starcie
document.addEventListener('DOMContentLoaded', function() {
  const isProMode = localStorage.getItem('bakeryProMode') === 'true';
  if (isProMode) {
    document.body.classList.add('pro-mode');
    document.getElementById('proToggle').textContent = 'üé® Tryb Standard';
  }
});

function cancelAddIngredientCategory() {
  document.getElementById('addIngredientCategoryForm').style.display = 'none';
  document.getElementById('newIngredientCategoryName').value = '';
}

function saveIngredientCategory() {
  const name = document.getElementById('newIngredientCategoryName').value.trim();
  if (!name) {
    showNotification('Podaj nazwƒô kategorii');
    return;
  }
  if (categories.includes(name)) {
    showNotification('Kategoria ju≈º istnieje');
    return;
  }
  categories.push(name);
  saveToStorage();
  cancelAddIngredientCategory();
  showNotification(`Dodano kategoriƒô: ${name}`);
  renderIngredientCategoriesList();
}
function createMobileNavigation() {
  if (window.innerWidth <= 768) {
    return `
      <div style="display: flex; justify-content: space-around; background: #ff6b6b; padding: 10px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;">
        <button onclick="showRecipes()" style="background: none; border: none; color: white; font-size: 12px; display: flex; flex-direction: column; align-items: center; min-width: 60px;">
          <span style="font-size: 20px;">üç∞</span>
          <span>Przepisy</span>
        </button>
        <button onclick="showIngredients()" style="background: none; border: none; color: white; font-size: 12px; display: flex; flex-direction: column; align-items: center; min-width: 60px;">
          <span style="font-size: 20px;">ü•Ñ</span>
          <span>Sk≈Çadniki</span>
        </button>
        <button onclick="showCalculator()" style="background: none; border: none; color: white; font-size: 12px; display: flex; flex-direction: column; align-items: center; min-width: 60px;">
          <span style="font-size: 20px;">üßÆ</span>
          <span>Kalkulator</span>
        </button>
        <button onclick="showSettings()" style="background: none; border: none; color: white; font-size: 12px; display: flex; flex-direction: column; align-items: center; min-width: 60px;">
          <span style="font-size: 20px;">‚öôÔ∏è</span>
          <span>Ustawienia</span>
        </button>
      </div>
      <div style="height: 80px;"></div> <!-- Spacer dla fixed menu -->
    `;
  }
  return ''; // Desktop navigation remains the same
}
function createMobileRecipeCard(recipe, index) {
  return `
    <div class="recipe-card mobile-full-width" style="
      background: white; 
      border-radius: 12px; 
      padding: 15px; 
      margin: 10px 0; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #ff6b6b;
    ">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
        <h3 style="margin: 0; color: #333; font-size: 16px; font-weight: bold;">${recipe.name}</h3>
        <div style="display: flex; gap: 5px;">
          <button onclick="editRecipe(${index})" class="clickable" style="
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            padding: 8px 12px; 
            font-size: 12px;
          ">‚úèÔ∏è</button>
          <button onclick="deleteRecipe(${index})" class="clickable" style="
            background: #dc3545; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            padding: 8px 12px; 
            font-size: 12px;
          ">üóëÔ∏è</button>
        </div>
      </div>
      
      <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
          <strong>Sk≈Çadniki:</strong> ${recipe.ingredients ? recipe.ingredients.length : 0}
        </div>
        <div style="font-size: 12px; color: #666;">
          <strong>Koszt:</strong> ${calculateRecipeCost(recipe).toFixed(2)} z≈Ç
        </div>
      </div>
      
      ${recipe.instructions ? `
        <div style="font-size: 12px; color: #555; line-height: 1.4;">
          ${recipe.instructions.substring(0, 100)}${recipe.instructions.length > 100 ? '...' : ''}
        </div>
      ` : ''}
    </div>
  `;
}
function createMobileForm() {
  return `
    <div class="mobile-full-width" style="padding: 15px;">
      <input type="text" placeholder="Nazwa przepisu..." style="
        width: 100%;
        min-height: 50px;
        font-size: 16px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin-bottom: 15px;
        box-sizing: border-box;
      ">
      
      <textarea placeholder="Instrukcje..." style="
        width: 100%;
        min-height: 120px;
        font-size: 16px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin-bottom: 15px;
        box-sizing: border-box;
        resize: vertical;
      "></textarea>
      
      <button style="
        width: 100%;
        min-height: 50px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
      ">üíæ Zapisz Przepis</button>
    </div>
  `;
}

function renderIngredientCategoriesList() {
  const container = document.getElementById('ingredientCategoriesList');
  if (!container) return;
  container.innerHTML = '<strong>IstniejƒÖce kategorie:</strong>';
  categories.forEach((cat, index) => {
    container.innerHTML += `
      <div style="display: flex; justify-content: space-between; align-items: center; margin: 4px 0;">
        <span>${cat}</span>
        <button class="btn btn-secondary btn-small" onclick="deleteIngredientCategory(${index})">üóëÔ∏è</button>
      </div>
    `;
  });
}

function deleteIngredientCategory(index) {
  const used = ingredients.some(ing => ing.category === categories[index]);
  if (used) {
    showNotification('Nie mo≈ºna usunƒÖƒá ‚Äì ta kategoria jest przypisana do sk≈Çadnik√≥w');
    return;
  }
  if (confirm(`UsunƒÖƒá kategoriƒô "${categories[index]}"?`)) {
    categories.splice(index, 1);
    saveToStorage();
    renderIngredientCategoriesList();
    showNotification('Kategoria usuniƒôta');
  }
}

    // Baza sk≈Çadnik√≥w
    let ingredients = [
      { id: 1, name: "MƒÖka pszenna", pricePerKg: 3.20, unit: "kg", category: "MƒÖki", allergen: "gluten" },
      { id: 2, name: "Cukier bia≈Çy", pricePerKg: 4.50, unit: "kg", category: "S≈Çodziki", allergen: "" },
      { id: 3, name: "Mas≈Ço", pricePerKg: 18.00, unit: "kg", category: "T≈Çuszcze", allergen: "mleko" },
      { id: 4, name: "Jajka", pricePerKg: 12.00, unit: "kg", category: "Nabia≈Ç", allergen: "jajka" },
      { id: 5, name: "Mleko", pricePerKg: 3.50, unit: "l", category: "Nabia≈Ç", allergen: "mleko" },
      { id: 6, name: "Twar√≥g", pricePerKg: 8.50, unit: "kg", category: "Nabia≈Ç", allergen: "mleko" },
      { id: 7, name: "≈ömietana 30%", pricePerKg: 9.00, unit: "l", category: "Nabia≈Ç", allergen: "mleko" },
      { id: 8, name: "Proszek do pieczenia", pricePerKg: 15.00, unit: "kg", category: "Dodatki", allergen: "" },
      { id: 9, name: "Wanilia", pricePerKg: 120.00, unit: "kg", category: "Aromaty", allergen: "" },
      { id: 10, name: "Czekolada gorzka", pricePerKg: 25.00, unit: "kg", category: "Czekolady", allergen: "mleko" }
	  
    ];
	let nextIngredientId = 1;
function updateNextIngredientId() {
  const maxId = ingredients.reduce((max, ing) => Math.max(max, ing.id || 0), 0);
  nextIngredientId = maxId + 1;
}


    // Kategorie
    let categories = ["Serniki", "Ciasta", "Torty", "Ciasteczka", "Tradycyjne", "Pieczywo"];
	let ingredientCategories = ["MƒÖki", "S≈Çodziki", "T≈Çuszcze", "Nabia≈Ç", "Czekolady", "Orzechy", "Dodatki", "Aromaty"];


    // Receptury
    let recipes = [];
    let selectedAllergens = [];
    let selectedRecipeForCalculator = null;
    let editingRecipeId = null;

    // LocalStorage
   function saveToStorage() {
  localStorage.setItem('cukiernia-pro-recipes', JSON.stringify(recipes));
  localStorage.setItem('cukiernia-pro-ingredients', JSON.stringify(ingredients));
  localStorage.setItem('cukiernia-pro-categories', JSON.stringify(categories));
  localStorage.setItem('ingredientCategories', JSON.stringify(ingredientCategories));
}

   function loadFromStorage() {
  const savedRecipes = localStorage.getItem('cukiernia-pro-recipes');
  if (savedRecipes) recipes.splice(0, recipes.length, ...JSON.parse(savedRecipes));

  const savedIngredients = localStorage.getItem('cukiernia-pro-ingredients');
  if (savedIngredients) ingredients.splice(0, ingredients.length, ...JSON.parse(savedIngredients));

  const savedCategories = localStorage.getItem('cukiernia-pro-categories');
  if (savedCategories) categories.splice(0, categories.length, ...JSON.parse(savedCategories));
  ingredientCategories = JSON.parse(localStorage.getItem('ingredientCategories')) || [];

  updateNextIngredientId();
 if (recipes.length > 0) {
  const maxId = recipes.reduce((max, recipe) => Math.max(max, recipe.id || 0), 0);
  nextRecipeId = maxId + 1;
  console.log('Ustawiono nextRecipeId na:', nextRecipeId);
}
  }
console.log("ZALADOWANO Z LOCALSTORAGE:", ingredients);

    // Funkcje nawigacji
    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.add('active');
      }
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const activeNavButton = document.querySelector(`[onclick*="showSection('${sectionName}')"]`);
      if (activeNavButton) {
        const navItem = activeNavButton.closest('.nav-item');
        if (navItem) navItem.classList.add('active');
      }
      
      const fab = document.getElementById('fab');
      if (fab) {
        if (sectionName === 'add-recipe') {
          fab.style.display = 'none';
        } else {
          fab.style.display = 'block';
          fab.onclick = () => showSection('add-recipe');
        }
      }
      
      if (sectionName === 'settings') {
        updateStatistics();
      } else if (sectionName === 'recipes') {
        loadRecipes();
      } else if (sectionName === 'ingredients') {
        loadIngredients();
		
      }
    }
function deleteRecipe(id) {
  if (!confirm("Na pewno chcesz usunƒÖƒá ten przepis?")) return;
  
  recipes = recipes.filter(recipe => recipe.id !== id);
  saveToStorage();
  loadRecipes(); // ‚Üê TO MUSI BYƒÜ!
  updateStatistics();
}
    // Funkcje przepis√≥w
function loadRecipes() {
  const container = document.getElementById('recipesList');

  if (recipes.length === 0) {
    container.innerHTML = 'Brak przepis√≥w'; // Odpowiedni komunikat
    return;
  }

  container.innerHTML = recipes.map(recipe => {
    const totalCost = calculateRecipeCost(recipe);
    const adjustedCost = recipe.yieldPercent ? totalCost / (recipe.yieldPercent / 100) : totalCost;
    const costPerServing = adjustedCost / recipe.servings;

    return `
      <div class="card recipe-card">
        <div class="recipe-header">
          <div style="display: flex; align-items: center;">
            <div class="recipe-icon">üßÅ</div>
            <div class="recipe-info">
              <h3>${recipe.name}</h3>
              <div class="recipe-meta">
                <span class="meta-tag">${recipe.category}</span>
                <span class="meta-tag">ID: ${recipe.id}</span>
                <span class="meta-tag">${recipe.servings}p</span>
                ${recipe.yieldPercent ? `<span class="meta-tag">${recipe.yieldPercent}% wydajno≈õƒá</span>` : ''}
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 6px;">
            <button class="btn btn-secondary btn-small" onclick="showRecipePreview(${recipe.id})">üëÅÔ∏è</button>
            <button class="btn btn-secondary btn-small" onclick="editRecipe(${recipe.id})">‚úèÔ∏è</button>
			<button class="btn btn-secondary btn-small" onclick="exportRecipeAdvanced(${recipe.id})" style="margin: 0; padding: 6px 8px;" title="Eksport przepisu">üì§</button>
            <button class="btn btn-secondary btn-small" onclick="printRecipe(${recipe.id})" style="margin: 0; padding: 6px 8px;">üñ®Ô∏è</button>
<button class="btn btn-secondary btn-small" onclick="openRecipeInNewTab(${recipe.id})" style="margin: 0; padding: 6px 8px;">üëÅÔ∏è</button>
<button class="btn btn-small" onclick="deleteRecipe(${recipe.id})" style="background: #dc2626; margin-left: 4px;">üóëÔ∏è</button>
          </div>
        </div>
        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-bottom: 4px;">${recipe.description || 'Brak opisu'}</div>
        <div style="background: rgba(5, 150, 105, 0.1); border-radius: 8px; padding: 12px; border: 1px solid rgba(5, 150, 105, 0.2);">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
            <div style="text-align: center;">
              <div style="color: #f87171;">Koszt ca≈Çkowity: ${adjustedCost.toFixed(2)} z≈Ç</div>
            </div>
            <div style="text-align: center;">
              <div style="color: #10b981;">Koszt/porcja: ${costPerServing.toFixed(2)} z≈Ç</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}


    function calculateRecipeCost(recipe) {
      if (!recipe.ingredients) return 0;
      
      return recipe.ingredients.reduce((total, recipeIngredient) => {
        const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
        if (!ingredient) return total;
        
        let cost = 0;
        const unit = recipeIngredient.unit;
        if (unit === 'kg') cost = recipeIngredient.amount * ingredient.pricePerKg;
        else if (unit === 'g') cost = (recipeIngredient.amount / 1000) * ingredient.pricePerKg;
        else if (unit === 'l') cost = recipeIngredient.amount * ingredient.pricePerKg;
        else if (unit === 'ml') cost = (recipeIngredient.amount / 1000) * ingredient.pricePerKg;
        else if (unit === 'szt') cost = (recipeIngredient.amount * 50 / 1000) * ingredient.pricePerKg;
        
        return total + cost;
      }, 0);
    }

    // Motyw
    let isDarkMode = true;

    function toggleTheme() {
      isDarkMode = !isDarkMode;
      const body = document.body;
      const themeToggle = document.querySelector('.theme-toggle');
      
      if (isDarkMode) {
        body.classList.remove('light-mode');
        themeToggle.textContent = '‚òÄÔ∏è';
      } else {
        body.classList.add('light-mode');
        themeToggle.textContent = 'üåô';
      }
      
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    function setTheme(theme) {
      const body = document.body;
      const themeToggle = document.querySelector('.theme-toggle');
      const currentThemeSpan = document.getElementById('currentTheme');
      
      if (theme === 'light') {
        body.classList.add('light-mode');
        themeToggle.textContent = 'üåô';
        currentThemeSpan.textContent = 'Jasny';
        isDarkMode = false;
      } else {
        body.classList.remove('light-mode');
        themeToggle.textContent = '‚òÄÔ∏è';
        currentThemeSpan.textContent = 'Ciemny';
        isDarkMode = true;
      }
      
      localStorage.setItem('theme', theme);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        setTheme(savedTheme);
      }
    }

    // Powiadomienia
    function showNotification(message) {
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-weight: 500;
        max-width: 300px;
        word-wrap: break-word;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, 3000);
    }

    // EXPORT Z WERYFIKACJƒÑ
function exportData() {
  const exportData = {
    recipes: recipes,
    ingredients: ingredients,
    settings: {
      exportDate: new Date().toISOString(),
      version: "4.0.17",
      totalRecipes: recipes.length,
      totalIngredients: ingredients.length
    }
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  const link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'cukiernia_backup_' + new Date().toISOString().split('T')[0] + '.json';
  link.click();
  
  showNotification('‚úÖ Dane wyeksportowane: ' + recipes.length + ' przepis√≥w, ' + ingredients.length + ' sk≈Çadnik√≥w');
}

// IMPORT Z WYKRYWANIEM DUPLIKAT√ìW
function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        
        if (!importedData.recipes || !importedData.ingredients) {
          showNotification('‚ùå Nieprawid≈Çowy format pliku!');
          return;
        }
        
        processImportWithDuplicateCheck(importedData);
        
      } catch (error) {
        showNotification('‚ùå B≈ÇƒÖd odczytu pliku!');
        console.error('Import error:', error);
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// PROCES IMPORTU Z KONTROLƒÑ DUPLIKAT√ìW
function processImportWithDuplicateCheck(importedData) {
  let newRecipes = 0;
  let duplicateRecipes = 0;
  let newIngredients = 0;
  let duplicateIngredients = 0;
  
  // IMPORT SK≈ÅADNIK√ìW
  importedData.ingredients.forEach(function(importedIng) {
    const existingIndex = ingredients.findIndex(function(existing) {
      const existingName = (existing.name || existing.nazwa || existing.ingredient || '').toLowerCase();
      const importedName = (importedIng.name || importedIng.nazwa || importedIng.ingredient || '').toLowerCase();
      return existingName === importedName;
    });
    
    if (existingIndex === -1) {
      // Nowy sk≈Çadnik
      ingredients.push(importedIng);
      newIngredients++;
    } else {
      // Aktualizuj istniejƒÖcy (opcjonalnie)
      duplicateIngredients++;
    }
  });
  
  // IMPORT PRZEPIS√ìW
  importedData.recipes.forEach(function(importedRecipe) {
    const existingIndex = recipes.findIndex(function(existing) {
      return existing.name.toLowerCase() === importedRecipe.name.toLowerCase();
    });
    
    if (existingIndex === -1) {
      // Nowy przepis
      recipes.push(importedRecipe);
      newRecipes++;
    } else {
      // Duplikat - dodaj z numerem
      const baseName = importedRecipe.name;
      let counter = 2;
      let newName = baseName + ' (' + counter + ')';
      
      while (recipes.some(r => r.name === newName)) {
        counter++;
        newName = baseName + ' (' + counter + ')';
      }
      
      importedRecipe.name = newName;
      recipes.push(importedRecipe);
      newRecipes++;
    }
  });
  
  // ZAPISZ DANE
  saveData();
  
  // POKA≈ª WYNIKI
  showNotification('‚úÖ Import uko≈Ñczony!\nüÜï Nowe: ' + newRecipes + ' przepis√≥w, ' + newIngredients + ' sk≈Çadnik√≥w\nüìã Duplikaty: ' + duplicateRecipes + ' przepis√≥w, ' + duplicateIngredients + ' sk≈Çadnik√≥w');
  
  // OD≈öWIE≈ª WIDOK
  if (currentView === 'recipes') {
    showRecipes();
  } else if (currentView === 'ingredients') {
    showIngredients();
  }
}

    function refreshData() {
      location.reload();
    }

    function resetAllData() {
      if (confirm('Czy na pewno chcesz usunƒÖƒá wszystkie dane? Ta operacja jest nieodwracalna.')) {
        localStorage.clear();
        location.reload();
      }
    }
	// GLOBALNE ZMIENNE WYSZUKIWANIA
let searchTimeout;
let filteredRecipes = [];
let currentSearchTerm = '';

// SZYBKIE WYSZUKIWANIE Z DEBOUNCE
function createSearchInterface() {
  return `
    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
        <div style="flex: 1; position: relative;">
          <input type="text" id="recipe-search" 
            style="width: 100%; padding: 12px 15px 12px 40px; border: 2px solid #ddd; border-radius: 25px; font-size: 16px;" 
            placeholder="üîç Szukaj przepis√≥w..." 
            oninput="performSearch(this.value)"
            autocomplete="off">
          <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999;">üîç</span>
        </div>
        <button onclick="clearSearch()" style="background: #6c757d; color: white; border: none; padding: 12px 15px; border-radius: 25px; font-size: 14px;">‚úï</button>
      </div>
      
      <!-- FILTRY -->
      <div style="display: flex; gap: 5px; flex-wrap: wrap;">
        <button onclick="filterByCategory('')" id="filter-all" class="filter-btn active" style="background: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px;">Wszystkie</button>
        <button onclick="filterByCategory('torty')" id="filter-torty" class="filter-btn" style="background: #f8f9fa; color: #333; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px;">Torty</button>
        <button onclick="filterByCategory('ciasta')" id="filter-ciasta" class="filter-btn" style="background: #f8f9fa; color: #333; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px;">Ciasta</button>
        <button onclick="filterByCategory('desery')" id="filter-desery" class="filter-btn" style="background: #f8f9fa; color: #333; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px;">Desery</button>
      </div>
      
      <div id="search-stats" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
    </div>
  `;
}

// FUNKCJA WYSZUKIWANIA Z DEBOUNCE
function performSearch(searchTerm) {
  clearTimeout(searchTimeout);
  
  searchTimeout = setTimeout(function() {
    currentSearchTerm = searchTerm.toLowerCase().trim();
    
    if (currentSearchTerm === '') {
      filteredRecipes = recipes;
    } else {
      filteredRecipes = recipes.filter(function(recipe) {
        // SZUKAJ W NAZWIE
        const nameMatch = recipe.name.toLowerCase().includes(currentSearchTerm);
        
        // SZUKAJ W SK≈ÅADNIKACH
        const ingredientMatch = recipe.ingredients && recipe.ingredients.some(function(ing) {
          const ingName = (ing.name || ing.ingredient || '').toLowerCase();
          return ingName.includes(currentSearchTerm);
        });
        
        // SZUKAJ W INSTRUKCJACH
        const instructionMatch = recipe.instructions && recipe.instructions.toLowerCase().includes(currentSearchTerm);
        
        return nameMatch || ingredientMatch || instructionMatch;
      });
    }
    
    updateSearchStats();
    displayFilteredRecipes();
  }, 300); // 300ms delay
}

// FILTROWANIE PO KATEGORIACH
function filterByCategory(category) {
  // Aktualizuj aktywny przycisk
  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.classList.remove('active');
    btn.style.background = '#f8f9fa';
    btn.style.color = '#333';
  });
  
  const activeBtn = document.getElementById('filter-' + (category || 'all'));
  if (activeBtn) {
    activeBtn.classList.add('active');
    activeBtn.style.background = '#ff6b6b';
    activeBtn.style.color = 'white';
  }
  
  if (category === '') {
    filteredRecipes = recipes;
  } else {
    filteredRecipes = recipes.filter(function(recipe) {
      return recipe.category && recipe.category.toLowerCase().includes(category);
    });
  }
  
  // Zastosuj r√≥wnie≈º wyszukiwanie tekstowe
  if (currentSearchTerm) {
    performSearch(currentSearchTerm);
  } else {
    updateSearchStats();
    displayFilteredRecipes();
  }
}

// AKTUALIZACJA STATYSTYK
function updateSearchStats() {
  const statsDiv = document.getElementById('search-stats');
  if (statsDiv) {
    if (currentSearchTerm) {
      statsDiv.innerHTML = 'üìä Znaleziono: <strong>' + filteredRecipes.length + '</strong> z ' + recipes.length + ' przepis√≥w dla "<em>' + currentSearchTerm + '</em>"';
    } else {
      statsDiv.innerHTML = 'üìä Wy≈õwietlane: <strong>' + filteredRecipes.length + '</strong> przepis√≥w';
    }
  }
}
function createRecipeCard(recipe, index) {
  const totalCost = calculateRecipeCost(recipe);
  const adjustedCost = recipe.yieldPercent ? totalCost / (recipe.yieldPercent / 100) : totalCost;
  const costPerServing = adjustedCost / recipe.servings;
  
  return `
    <div class="card recipe-card">
      <div class="recipe-header">
        <div style="display: flex; align-items: center;">
          <h3>${recipe.name}</h3>
        </div>
        <div class="recipe-info">
          <span class="meta-tag">ID: ${recipe.id}</span>
          <span class="meta-tag">${recipe.category}</span>
          <span class="meta-tag">Porcje: ${recipe.servings}</span>
          ${recipe.yieldPercent ? '<span class="meta-tag">${recipe.yieldPercent}% wydajno≈õƒá</span>' : ''}
        </div>
      </div>
      <div class="recipe-actions">
        <button class="btn btn-secondary btn-small" onclick="showRecipePreview(${recipe.id})" style="margin: 0; padding: 6px 8px;">üëÅ</button>
        <button class="btn btn-secondary btn-small" onclick="editRecipe(${recipe.id})" style="margin: 0; padding: 6px 8px;">‚úèÔ∏è</button>
        <button class="btn btn-secondary btn-small" onclick="exportRecipeToPDF(${recipe.id})" style="margin: 0; padding: 6px 8px;">üìÑ</button>
      </div>
    </div>`;
}


// WYCZY≈öƒÜ WYSZUKIWANIE
function clearSearch() {
  document.getElementById('recipe-search').value = '';
  currentSearchTerm = '';
  filteredRecipes = recipes;
  filterByCategory(''); // Reset do "wszystkie"
}function showRecipes() {
  currentView = 'recipes';
  filteredRecipes = recipes; // Zainicjuj z wszystkimi przepisami
  
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="container">
      <div class="header">
        <h2>üç∞ Moje Przepisy (${recipes.length})</h2>
        <button onclick="addRecipe()" class="btn btn-primary">‚ûï Dodaj Przepis</button>
      </div>
      
      ${createSearchInterface()}
      
      <div id="recipes-container">
        ${recipes.map((recipe, index) => createRecipeCard(recipe, index)).join('')}
      </div>
    </div>
  `;
}

    // Statystyki
    function updateStatistics() {
      const totalCost = recipes.reduce((sum, recipe) => {
        const recipeCost = calculateRecipeCost(recipe);
        return sum + recipeCost;
      }, 0);
      
      const avgCost = recipes.length > 0 ? totalCost / recipes.length : 0;
      const uniqueCategories = [...new Set(recipes.map(r => r.category))].length;
      
      document.getElementById('statsRecipes').textContent = recipes.length;
      document.getElementById('statsIngredients').textContent = ingredients.length;
      document.getElementById('statsCategories').textContent = uniqueCategories;
      document.getElementById('statsAvgCost').textContent = avgCost.toFixed(2) + ' z≈Ç';
      
      document.getElementById('totalRecipes').textContent = `${recipes.length} przepis√≥w`;
      document.getElementById('totalIngredients').textContent = `${ingredients.length} sk≈Çadnik√≥w`;
    }

    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', function() {
      loadFromStorage();
      loadTheme();
      updateStatistics();
      loadRecipes();
      loadIngredients();
      populateCategories();
	  populateIngredientCategories();

      
      showNotification('‚úÖ Cukiernia Pro za≈Çadowana!');
    });

    // Funkcje sk≈Çadnik√≥w w przepisach
    function addIngredientRow() {
      const container = document.getElementById('ingredientsList');
      const newItem = document.createElement('div');
      newItem.className = 'ingredient-item';
      newItem.innerHTML = `
        <div style="position: relative; flex: 2;">
          <input type="text" class="form-input ingredient-input" placeholder="Wpisz sk≈Çadnik..." 
                 oninput="showIngredientSuggestions(this)" 
                 onfocus="showIngredientSuggestions(this)"
                 onblur="hideIngredientSuggestions(this)" />
          <div class="ingredient-suggestions" style="display: none;"></div>
        </div>
        <input type="number" class="form-input amount-input" placeholder="Ilo≈õƒá" step="0.01" oninput="calculateRecipeCostLive()" />
        <select class="form-select unit-select" onchange="calculateRecipeCostLive()">
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="l">l</option>
          <option value="ml">ml</option>
          <option value="szt">szt</option>
        </select>
        <button class="remove-btn" onclick="removeIngredient(this)">üóëÔ∏è</button>
      `;
      container.appendChild(newItem);
    }

    function removeIngredient(button) {
      const row = button.closest('.ingredient-item');
      row.remove();
      calculateRecipeCostLive();
    }

    function showIngredientSuggestions(input) {
      const query = input.value.toLowerCase();
      const suggestionsDiv = input.parentNode.querySelector('.ingredient-suggestions');
      
      if (query.length < 1) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      const filtered = ingredients.filter(ing => 
        ing.name.toLowerCase().includes(query)
      ).slice(0, 5);
      
      if (filtered.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      const html = filtered.map(ing => `
        <div class="suggestion-item" onclick="selectIngredient(this, ${ing.id}, '${ing.name}')">
          <div style="font-weight: 500;">${ing.name}</div>
          <div style="font-size: 0.8rem; opacity: 0.7;">${ing.pricePerKg.toFixed(2)} z≈Ç/${ing.unit} ‚Ä¢ ${ing.category}</div>
        </div>
      `).join('');
      
      suggestionsDiv.innerHTML = html;
      suggestionsDiv.style.display = 'block';
    }

    function hideIngredientSuggestions(input) {
      setTimeout(() => {
        const suggestionsDiv = input.parentNode.querySelector('.ingredient-suggestions');
        suggestionsDiv.style.display = 'none';
      }, 200);
    }

    function selectIngredient(element, ingredientId, ingredientName) {
      const row = element.closest('.ingredient-item');
      const input = row.querySelector('.ingredient-input');
      const suggestionsDiv = row.querySelector('.ingredient-suggestions');
      
      input.value = ingredientName;
      input.dataset.ingredientId = ingredientId;
      suggestionsDiv.style.display = 'none';
      
      const amountInput = row.querySelector('.amount-input');
      amountInput.focus();
      
      calculateRecipeCostLive();
    }

    // Kalkulacja koszt√≥w na ≈ºywo
    function calculateRecipeCostLive() {
      const ingredientItems = document.querySelectorAll('#ingredientsList .ingredient-item');
      let totalCost = 0;
      let totalWeight = 0;
      let breakdown = '';
      let percentageBreakdown = '';
      
      // Najpierw oblicz ca≈ÇkowitƒÖ wagƒô
      ingredientItems.forEach(item => {
        const ingredientInput = item.querySelector('.ingredient-input');
        const amountInput = item.querySelector('.amount-input');
        const unitSelect = item.querySelector('.unit-select');
        
        if (ingredientInput && ingredientInput.dataset.ingredientId && amountInput.value) {
          const amount = parseFloat(amountInput.value);
          const unit = unitSelect.value;
          
          let weightInGrams = 0;
          if (unit === 'kg') weightInGrams = amount * 1000;
          else if (unit === 'g') weightInGrams = amount;
          else if (unit === 'l') weightInGrams = amount * 1000;
          else if (unit === 'ml') weightInGrams = amount;
          else if (unit === 'szt') weightInGrams = amount * 50;
          
          totalWeight += weightInGrams;
        }
      });
      
      // Teraz oblicz koszty i procenty
      ingredientItems.forEach(item => {
        const ingredientInput = item.querySelector('.ingredient-input');
        const amountInput = item.querySelector('.amount-input');
        const unitSelect = item.querySelector('.unit-select');
        
        if (ingredientInput && ingredientInput.dataset.ingredientId && amountInput.value) {
          const ingredient = ingredients.find(ing => ing.id === parseInt(ingredientInput.dataset.ingredientId));
          if (ingredient) {
            const amount = parseFloat(amountInput.value);
            const unit = unitSelect.value;
            
            let cost = 0;
            let weightInGrams = 0;
            
            if (unit === 'kg') {
              cost = amount * ingredient.pricePerKg;
              weightInGrams = amount * 1000;
            } else if (unit === 'g') {
              cost = (amount / 1000) * ingredient.pricePerKg;
              weightInGrams = amount;
            } else if (unit === 'l') {
              cost = amount * ingredient.pricePerKg;
              weightInGrams = amount * 1000;
            } else if (unit === 'ml') {
              cost = (amount / 1000) * ingredient.pricePerKg;
              weightInGrams = amount;
            } else if (unit === 'szt') {
              cost = (amount * 50 / 1000) * ingredient.pricePerKg;
              weightInGrams = amount * 50;
            }
            
            totalCost += cost;
            
            const percentage = totalWeight > 0 ? (weightInGrams / totalWeight * 100).toFixed(1) : '0.0';
            
            breakdown += `
              <div class="cost-line">
                <span>${ingredient.name} (${amount} ${unit})</span>
                <span>${cost.toFixed(2)} z≈Ç</span>
              </div>
            `;
            
            percentageBreakdown += `
              <div class="cost-line">
                <span>${ingredient.name}</span>
                <span>${percentage}%</span>
              </div>
            `;
          }
        }
      });
      
      if (totalCost > 0) {
        const yieldPercent = parseFloat(document.getElementById('recipeYield').value) || 95;
        const adjustedCost = totalCost / (yieldPercent / 100);
        
        breakdown += `
          <div class="cost-line">
            <span><strong>RAZEM (${yieldPercent}% wydajno≈õƒá)</strong></span>
            <span><strong>${adjustedCost.toFixed(2)} z≈Ç</strong></span>
          </div>
        `;
        
        document.getElementById('costBreakdown').innerHTML = breakdown;
        document.getElementById('percentageBreakdown').innerHTML = percentageBreakdown;
        document.getElementById('costCalculation').style.display = 'block';
      } else {
        document.getElementById('costCalculation').style.display = 'none';
      }
    }

    // Funkcje alergen√≥w
   function toggleAllergen(element) {
  const allergen = element.dataset.allergen;
  if (selectedAllergens.includes(allergen)) {
    selectedAllergens = selectedAllergens.filter(a => a !== allergen);
    element.classList.remove('active');
  } else {
    selectedAllergens.push(allergen);
    element.classList.add('active');
  }
}


    // Funkcje kategorii
    function populateCategories() {
      const categorySelect = document.getElementById('recipeCategory');
      if (!categorySelect) return;
      
      const options = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      categorySelect.innerHTML = '<option value="">Wybierz kategoriƒô...</option>' + options;
	 
    }
function populateIngredientCategories() {
  const select = document.getElementById('newIngredientCategory');
  if (!select) return;
  
  select.innerHTML = '<option value="">Wybierz kategoriƒô...</option>' +
    ingredientCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
}

    function showAddCategory() {
      document.getElementById('addCategoryForm').style.display = 'block';
      document.getElementById('newCategoryName').focus();
    }

    function cancelAddCategory() {
      document.getElementById('addCategoryForm').style.display = 'none';
      document.getElementById('newCategoryName').value = '';
    }

    function saveNewCategory() {
      const name = document.getElementById('newCategoryName').value.trim();
      if (!name) {
        showNotification('Wpisz nazwƒô kategorii');
        return;
      }
      
      if (categories.includes(name)) {
        showNotification('Kategoria ju≈º istnieje');
        return;
      }
      
      categories.push(name);
      saveToStorage();
      populateCategories();
      
      document.getElementById('recipeCategory').value = name;
      
      cancelAddCategory();
      showNotification(`Kategoria "${name}" dodana!`);
    }

    // Funkcje zapisywania przepis√≥w
    function saveRecipe() {
      const name = document.getElementById('recipeName').value.trim();
      const category = document.getElementById('recipeCategory').value;
      const description = document.getElementById('recipeDescription').value.trim();
      const servings = parseInt(document.getElementById('recipeServings').value) || 1;

      const yieldPercent = parseFloat(document.getElementById('recipeYield').value) || 95;
      const instructions = document.getElementById('recipeInstructions').value.trim();
	  const dietary = {
  vegan: document.getElementById('vegan') ? document.getElementById('vegan').checked : false,
  lactoseFree: document.getElementById('lactose-free') ? document.getElementById('lactose-free').checked : false,
  glutenFree: document.getElementById('gluten-free') ? document.getElementById('gluten-free').checked : false
};
      
      if (!name) {
        showNotification('Wpisz nazwƒô przepisu');
        return;
      }
      
      if (!category) {
        showNotification('Wybierz kategoriƒô');
        return;
      }
      
      // Zbierz sk≈Çadniki
      const ingredientItems = document.querySelectorAll('#ingredientsList .ingredient-item');
      const recipeIngredients = [];
      
      ingredientItems.forEach(item => {
        const ingredientInput = item.querySelector('.ingredient-input');
        const amountInput = item.querySelector('.amount-input');
        const unitSelect = item.querySelector('.unit-select');
        
        if (ingredientInput && ingredientInput.dataset.ingredientId && amountInput.value) {
          recipeIngredients.push({
            ingredientId: parseInt(ingredientInput.dataset.ingredientId),
            amount: parseFloat(amountInput.value),
            unit: unitSelect.value
          });
        }
      });
      
      if (recipeIngredients.length === 0) {
        showNotification('Dodaj przynajmniej jeden sk≈Çadnik');
        return;
      }
      
      const recipe = {
        id: editingRecipeId || nextRecipeId++,
        name,
        category,
        description,
        servings,
        yieldPercent,
        instructions,
        ingredients: recipeIngredients,
        allergens: [...selectedAllergens],
		dietary: dietary,
        createdAt: editingRecipeId ? recipes.find(r => r.id === editingRecipeId)?.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      if (editingRecipeId) {
        const index = recipes.findIndex(r => r.id === editingRecipeId);
        if (index !== -1) {
          recipes[index] = recipe;
          showNotification('Przepis zaktualizowany!');
        }
        editingRecipeId = null;
      } else {
        recipes.push(recipe);
        showNotification('Przepis zapisany!');
      }
      
      saveToStorage();
      clearRecipeForm();
      showSection('recipes');
    }
function showProTab(tab) {
  // Zmie≈Ñ aktywnƒÖ zak≈Çadkƒô - BEZ event.target
  document.querySelectorAll('.pro-tab').forEach(t => t.classList.remove('active'));
  
  // Znajd≈∫ zak≈Çadkƒô wed≈Çug tekstu
  const tabs = document.querySelectorAll('.pro-tab');
  tabs.forEach(t => {
    if (t.textContent.includes(tab.toUpperCase()) || 
        t.textContent.includes('PRZEPISY') && tab === 'recipes' ||
        t.textContent.includes('SK≈ÅADNIKI') && tab === 'ingredients' ||
        t.textContent.includes('KALKULATOR') && tab === 'calculator') {
      t.classList.add('active');
    }
  });
  
  const content = document.getElementById('pro-content');
  if (content) {
    if (tab === 'recipes') {
      content.innerHTML = `
        <h2>üìã LISTA PRZEPIS√ìW - TRYB PRO</h2>
        <p>Liczba przepis√≥w: <strong>${recipes.length}</strong></p>
        <div style="background: white; border: 2px solid black; padding: 15px; margin: 10px 0;">
          <h3>FUNKCJA DZIA≈ÅA!</h3>
          <p>Pro interface zosta≈Ç za≈Çadowany pomy≈õlnie.</p>
          <p>Tutaj bƒôdzie tabela przepis√≥w...</p>
        </div>
      `;
    } else {
      content.innerHTML = `<h2>Zak≈Çadka: ${tab}</h2><p>W przygotowaniu...</p>`;
    }
  }
}
function loadProRecipesList() {
  const content = document.getElementById('pro-content');
  content.innerHTML = `
    <div style="background: #f8f9fa; padding: 8px; border: 1px solid #666; margin-bottom: 5px;">
      <button onclick="addNewRecipePro()" style="background: #28a745; color: white; border: none; padding: 6px 12px; font-size: 10px; margin-right: 5px;">+ NOWY PRZEPIS</button>
      <button onclick="exportAllRecipesPro()" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 10px; margin-right: 5px;">üìä EKSPORT WSZYSTKICH</button>
      <span style="float: right;">≈ÅƒÖcznie przepis√≥w: <strong>${recipes.length}</strong></span>
    </div>
    
    <table class="pro-table">
      <thead>
        <tr>
          <th width="30">#</th>
          <th width="200">NAZWA PRZEPISU</th>
          <th width="100">KATEGORIA</th>
          <th width="60">PORCJE</th>
          <th width="80">SK≈ÅADNIKI</th>
          <th width="80">KOSZT TOTAL</th>
          <th width="80">KOSZT/PORCJA</th>
          <th width="70">WYDAJNO≈öƒÜ</th>
          <th width="120">AKCJE</th>
        </tr>
      </thead>
      <tbody id="pro-recipes-tbody">
      </tbody>
    </table>
  `;
  
  const tbody = document.getElementById('pro-recipes-tbody');
  tbody.innerHTML = '';
  
  recipes.forEach((recipe, index) => {
    const totalCost = calculateRecipeCost(recipe);
    const costPerServing = totalCost / recipe.servings;
    const yieldPercent = recipe.yieldPercent || 95;
    
    tbody.innerHTML += `
      <tr ondblclick="editRecipePro(${recipe.id})" style="cursor: pointer;">
        <td style="text-align: center; font-weight: bold;">${index + 1}</td>
        <td><strong>${recipe.name}</strong></td>
        <td style="font-size: 9px;">${recipe.category || '-'}</td>
        <td style="text-align: center;">${recipe.servings}</td>
        <td style="text-align: center;">${recipe.ingredients.length}</td>
        <td style="text-align: right; font-weight: bold;">${totalCost.toFixed(2)} z≈Ç</td>
        <td style="text-align: right;">${costPerServing.toFixed(2)} z≈Ç</td>
        <td style="text-align: center;">${yieldPercent}%</td>
        <td style="text-align: center;">
          <button onclick="viewRecipePro(${recipe.id})" style="font-size: 8px; padding: 1px 4px; margin: 1px;">üëÅ</button>
          <button onclick="editRecipePro(${recipe.id})" style="font-size: 8px; padding: 1px 4px; margin: 1px;">‚úè</button>
          <button onclick="exportRecipeToPDF(${recipe.id})" style="font-size: 8px; padding: 1px 4px; margin: 1px;">üìÑ</button>
          <button onclick="deleteRecipe(${recipe.id})" style="font-size: 8px; padding: 1px 4px; margin: 1px; background: #dc2626; color: white;">üóë</button>
        </td>
      </tr>
    `;
  });
}
function viewRecipePro(recipeId) {
  const recipe = recipes.find(r => r.id === recipeId);
  if (!recipe) return;
  
  const content = document.getElementById('pro-content');
  const totalCost = calculateRecipeCost(recipe);
  const yieldPercent = recipe.yieldPercent || 95;
  const adjustedCost = totalCost / (yieldPercent / 100);
  
  // Oblicz wagƒô sk≈Çadnik√≥w
  let totalWeight = 0;
  const ingredientsTable = recipe.ingredients.map(recipeIngredient => {
    const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
    if (!ingredient) return '';
    
    let weightInGrams = recipeIngredient.amount;
    if (recipeIngredient.unit === 'kg') weightInGrams *= 1000;
    else if (recipeIngredient.unit === 'l') weightInGrams *= 1000;
    else if (recipeIngredient.unit === 'ml') weightInGrams *= 1;
    else if (recipeIngredient.unit === 'szt') weightInGrams *= 50;
    
    totalWeight += weightInGrams;
    return { ingredient, recipeIngredient, weightInGrams };
  }).filter(item => item !== '');
  
  const ingredientsHtml = ingredientsTable.map(item => {
    const cost = calculateIngredientCost(item.recipeIngredient.amount, item.recipeIngredient.unit, item.ingredient);
    const percent = totalWeight > 0 ? (item.weightInGrams / totalWeight * 100) : 0;
    
    return `
      <tr>
        <td>${item.ingredient.name}</td>
        <td style="text-align: center;">${item.recipeIngredient.amount}</td>
        <td style="text-align: center;">${item.recipeIngredient.unit}</td>
        <td style="text-align: center; font-weight: bold;">${percent.toFixed(1)}%</td>
        <td style="text-align: right;">${cost.toFixed(2)} z≈Ç</td>
      </tr>
    `;
  }).join('');
  
  content.innerHTML = `
    <div style="background: #f8f9fa; padding: 8px; border: 1px solid #666; margin-bottom: 5px;">
      <button onclick="loadProRecipesList()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; font-size: 10px;">‚Üê POWR√ìT DO LISTY</button>
      <button onclick="editRecipePro(${recipeId})" style="background: #28a745; color: white; border: none; padding: 6px 12px; font-size: 10px; margin-left: 5px;">‚úè EDYTUJ</button>
      <button onclick="exportRecipeToPDF(${recipeId})" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 10px; margin-left: 5px;">üìÑ PDF</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
      <div style="background: #ffffff; border: 2px solid #000; padding: 10px;">
        <h3 style="margin: 0 0 8px 0; background: #e9ecef; padding: 5px; font-size: 11px;">INFORMACJE PODSTAWOWE</h3>
        <table style="width: 100%; font-size: 10px;">
          <tr><td><strong>Nazwa:</strong></td><td>${recipe.name}</td></tr>
          <tr><td><strong>ID:</strong></td><td>${recipe.id}</td></tr>
          <tr><td><strong>Kategoria:</strong></td><td>${recipe.category || '-'}</td></tr>
          <tr><td><strong>Porcje:</strong></td><td>${recipe.servings}</td></tr>
          <tr><td><strong>Wydajno≈õƒá:</strong></td><td>${yieldPercent}%</td></tr>
          <tr><td><strong>Waga sk≈Çadnik√≥w:</strong></td><td>${totalWeight.toFixed(0)}g</td></tr>
        </table>
      </div>
      
      <div style="background: #ffffff; border: 2px solid #000; padding: 10px;">
        <h3 style="margin: 0 0 8px 0; background: #e9ecef; padding: 5px; font-size: 11px;">KALKULACJA KOSZT√ìW</h3>
        <table style="width: 100%; font-size: 10px;">
          <tr><td><strong>Koszt sk≈Çadnik√≥w:</strong></td><td>${totalCost.toFixed(2)} z≈Ç</td></tr>
          <tr><td><strong>Po wydajno≈õci:</strong></td><td>${adjustedCost.toFixed(2)} z≈Ç</td></tr>
          <tr><td><strong>Koszt na porcjƒô:</strong></td><td>${(adjustedCost / recipe.servings).toFixed(2)} z≈Ç</td></tr>
          <tr><td><strong>Alergeny:</strong></td><td>${recipe.allergens && recipe.allergens.length > 0 ? recipe.allergens.join(', ') : 'brak'}</td></tr>
        </table>
      </div>
    </div>
    
    <div style="background: #ffffff; border: 2px solid #000;">
      <h3 style="margin: 0; background: #e9ecef; padding: 8px; font-size: 11px;">SK≈ÅADNIKI</h3>
      <table class="pro-table" style="margin: 0;">
        <thead>
          <tr>
            <th>SK≈ÅADNIK</th>
            <th width="80">ILO≈öƒÜ</th>
            <th width="80">JEDNOSTKA</th>
            <th width="80">UDZIA≈Å %</th>
            <th width="80">KOSZT</th>
          </tr>
        </thead>
        <tbody>
          ${ingredientsHtml}
          <tr style="background: #f0f0f0; font-weight: bold;">
            <td>RAZEM</td>
            <td style="text-align: center;">${totalWeight.toFixed(0)}g</td>
            <td style="text-align: center;">-</td>
            <td style="text-align: center;">100.0%</td>
            <td style="text-align: right;">${adjustedCost.toFixed(2)} z≈Ç</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    ${recipe.instructions ? `
      <div style="background: #ffffff; border: 2px solid #000; margin-top: 10px;">
        <h3 style="margin: 0; background: #e9ecef; padding: 8px; font-size: 11px;">INSTRUKCJE PRODUKCJI</h3>
        <div style="padding: 10px; white-space: pre-line; font-size: 10px;">
          ${recipe.instructions}
        </div>
      </div>
    ` : ''}
  `;
}

function addNewRecipePro() {
  showNotification('Funkcja dodawania nowego przepisu - w przygotowaniu');
  // TODO: Dodaƒá formularz w trybie Pro
} 		
function showProRecipes() {
  const content = document.getElementById('pro-content');
  if (content) {
    content.innerHTML = `
      <h2>üìä LISTA PRZEPIS√ìW - TRYB PRO</h2>
      <p><strong>≈ÅƒÖcznie przepis√≥w:</strong> ${recipes.length}</p>
      <div style="background: white; border: 1px solid black; padding: 10px; margin: 10px 0;">
        <h3>Twoje przepisy:</h3>
        <ul>
          ${recipes.map(recipe => `<li>${recipe.name} (${recipe.servings} porcji)</li>`).join('')}
        </ul>
      </div>
    `;
  }
}

function editRecipePro(recipeId) {
  showNotification('Funkcja edycji przepisu - w przygotowaniu');
  // TODO: Dodaƒá edycjƒô w trybie Pro
}

function exportAllRecipesPro() {
  showNotification('Eksport wszystkich przepis√≥w - w przygotowaniu');
  // TODO: Dodaƒá eksport Excel
}

    function clearRecipeForm() {
      document.getElementById('recipeName').value = '';
      document.getElementById('recipeCategory').value = '';
      document.getElementById('recipeDescription').value = '';
      document.getElementById('recipeServings').value = '1';

      document.getElementById('recipeYield').value = '95';
      document.getElementById('recipeInstructions').value = '';
      
      // Wyczy≈õƒá sk≈Çadniki (zostaw tylko pierwszy wiersz)
      const container = document.getElementById('ingredientsList');
      const firstRow = container.querySelector('.ingredient-item');
      container.innerHTML = '';
      if (firstRow) {
        firstRow.querySelector('.ingredient-input').value = '';
        firstRow.querySelector('.ingredient-input').dataset.ingredientId = '';
        firstRow.querySelector('.amount-input').value = '';
        firstRow.querySelector('.unit-select').value = 'kg';
        container.appendChild(firstRow);
      }
      
      // Wyczy≈õƒá alergeny
      selectedAllergens = [];
      document.querySelectorAll('.allergen-tag').forEach(tag => {
        tag.classList.remove('active');
      });
      
      // Ukryj kalkulacjƒô
      document.getElementById('costCalculation').style.display = 'none';
      
      editingRecipeId = null;
    }

    function editRecipe(recipeId) {
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) return;
      
      editingRecipeId = recipeId;
      
      // Wype≈Çnij formularz (tylko istniejƒÖce pola)
      const nameField = document.getElementById('recipeName');
      const categoryField = document.getElementById('recipeCategory');
      const descriptionField = document.getElementById('recipeDescription');
      const servingsField = document.getElementById('recipeServings');
      const yieldField = document.getElementById('recipeYield');
      const instructionsField = document.getElementById('recipeInstructions');
      
      if (nameField) nameField.value = recipe.name;
      if (categoryField) categoryField.value = recipe.category;
      if (descriptionField) descriptionField.value = recipe.description || '';
      if (servingsField) servingsField.value = recipe.servings;
      if (yieldField) yieldField.value = recipe.yieldPercent || 95;
      if (instructionsField) instructionsField.value = recipe.instructions || '';
      
      // Wype≈Çnij sk≈Çadniki
      const container = document.getElementById('ingredientsList');
      container.innerHTML = '';
      
      recipe.ingredients.forEach((recipeIngredient, index) => {
        const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
        if (ingredient) {
          const newItem = document.createElement('div');
          newItem.className = 'ingredient-item';
          newItem.innerHTML = `
            <div style="position: relative; flex: 2;">
              <input type="text" class="form-input ingredient-input" placeholder="Wpisz sk≈Çadnik..." 
                     value="${ingredient.name}"
                     data-ingredient-id="${ingredient.id}"
                     oninput="showIngredientSuggestions(this)" 
                     onfocus="showIngredientSuggestions(this)"
                     onblur="hideIngredientSuggestions(this)" />
              <div class="ingredient-suggestions" style="display: none;"></div>
            </div>
            <input type="number" class="form-input amount-input" placeholder="Ilo≈õƒá" step="0.01" 
                   value="${recipeIngredient.amount}" oninput="calculateRecipeCostLive()" />
            <select class="form-select unit-select" onchange="calculateRecipeCostLive()">
              <option value="kg" ${recipeIngredient.unit === 'kg' ? 'selected' : ''}>kg</option>
              <option value="g" ${recipeIngredient.unit === 'g' ? 'selected' : ''}>g</option>
              <option value="l" ${recipeIngredient.unit === 'l' ? 'selected' : ''}>l</option>
              <option value="ml" ${recipeIngredient.unit === 'ml' ? 'selected' : ''}>ml</option>
              <option value="szt" ${recipeIngredient.unit === 'szt' ? 'selected' : ''}>szt</option>
            </select>
            <button class="remove-btn" onclick="removeIngredient(this)">üóëÔ∏è</button>
          `;
          container.appendChild(newItem);
        }
      });
      
      // Wype≈Çnij alergeny
      selectedAllergens = [...(recipe.allergens || [])];
      document.querySelectorAll('.allergen-tag').forEach(tag => {
        const allergen = tag.onclick.toString().match(/'([^']+)'/)?.[1];
        if (allergen && selectedAllergens.includes(allergen)) {
          tag.classList.add('active');
        } else {
          tag.classList.remove('active');
        }
      });
      
      calculateRecipeCostLive();
      showSection('add-recipe');
      showNotification('Przepis za≈Çadowany do edycji');
    }

    function showRecipePreview(recipeId) {
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) return;
      
      const totalCost = calculateRecipeCost(recipe);
      const adjustedCost = recipe.yieldPercent ? totalCost / (recipe.yieldPercent / 100) : totalCost;
      
      // Tworzymy modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        box-sizing: border-box;
      `;
      
      // Sk≈Çadniki z kosztami
      const ingredientsHtml = recipe.ingredients.map(recipeIngredient => {
        const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
        if (!ingredient) return '<div class="ingredient-line">Nieznany sk≈Çadnik</div>';
        
        let cost = 0;
        const unit = recipeIngredient.unit;
        if (unit === 'kg') cost = recipeIngredient.amount * ingredient.pricePerKg;
        else if (unit === 'g') cost = (recipeIngredient.amount / 1000) * ingredient.pricePerKg;
        else if (unit === 'l') cost = recipeIngredient.amount * ingredient.pricePerKg;
        else if (unit === 'ml') cost = (recipeIngredient.amount / 1000) * ingredient.pricePerKg;
        else if (unit === 'szt') cost = (recipeIngredient.amount * 50 / 1000) * ingredient.pricePerKg;
        
        return `
          <div class="ingredient-line">
            <span>${ingredient.name}</span>
            <span>${recipeIngredient.amount} ${recipeIngredient.unit}</span>
            <span>${cost.toFixed(2)} z≈Ç</span>
          </div>
        `;
      }).join('');
      
      modal.innerHTML = `
        <div style="
          background: var(--card-bg);
          border-radius: 12px;
          padding: 24px;
          max-width: 600px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          position: relative;
          border: 1px solid var(--border-color);
        ">
          <button onclick="this.closest('div').parentElement.remove()" style="
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">√ó</button>
          
          <div style="margin-bottom: 20px;">
            <h2 style="margin: 0 0 8px 0; color: var(--primary-color); font-size: 1.4rem;">${recipe.name}</h2>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
              <span style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">ID: ${recipe.id}</span>
              <span style="background: rgba(5, 150, 105, 0.2); color: #10b981; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${recipe.category}</span>
              <span style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${recipe.servings} porcji</span>
              <span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${recipe.yieldPercent || 95}% wydajno≈õƒá</span>
            </div>
            ${recipe.description ? `<p style="color: rgba(255,255,255,0.8); margin: 12px 0; line-height: 1.4;">${recipe.description}</p>` : ''}
          </div>
          
          <div style="
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
          ">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: center;">
              <div>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Koszt ca≈Çkowity</div>
                <div style="font-size: 1.2rem; font-weight: 600; color: #f87171;">${adjustedCost.toFixed(2)} z≈Ç</div>
              </div>
              <div>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 4px;">Koszt na porcjƒô</div>
                <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">${(adjustedCost / recipe.servings).toFixed(2)} z≈Ç</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--secondary-color); margin-bottom: 12px; font-size: 1.1rem;">Sk≈Çadniki</h3>
            <div style="
              background: rgba(0,0,0,0.2);
              border-radius: 8px;
              padding: 12px;
            ">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 8px; padding: 0 8px;">
                <div>Sk≈Çadnik</div>
                <div style="text-align: center;">Ilo≈õƒá</div>
                <div style="text-align: right;">Koszt</div>
              </div>
              <div style="display: grid; gap: 4px;">
                ${ingredientsHtml}
              </div>
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(5, 150, 105, 0.3);">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; font-weight: 600; color: #10b981; padding: 0 8px;">
                  <div>RAZEM (${recipe.yieldPercent || 95}% wydajno≈õƒá)</div>
                  <div></div>
                  <div style="text-align: right;">${adjustedCost.toFixed(2)} z≈Ç</div>
                </div>
              </div>
            </div>
          </div>
          
          ${recipe.allergens && recipe.allergens.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: var(--secondary-color); margin-bottom: 8px; font-size: 1.1rem;">Alergeny</h3>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                ${recipe.allergens.map(allergen => 
                  `<span style="background: rgba(220, 38, 38, 0.2); color: #fca5a5; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">${allergen}</span>`
                ).join('')}
              </div>
            </div>
          ` : ''}
          
          ${recipe.instructions ? `
            <div>
              <h3 style="color: var(--secondary-color); margin-bottom: 12px; font-size: 1.1rem;">Instrukcje</h3>
              <div style="
                background: rgba(0,0,0,0.2);
                border-radius: 8px;
                padding: 16px;
                line-height: 1.6;
                color: rgba(255,255,255,0.9);
                white-space: pre-line;
              ">${recipe.instructions}</div>
            </div>
          ` : ''}
        </div>
      `;
      
      // Dodajemy style dla ingredient-line
      const style = document.createElement('style');
      style.textContent = `
        .ingredient-line {
          display: grid;
          grid-template-columns: 2fr 1fr 1fr;
          gap: 8px;
          padding: 8px;
          background: rgba(255,255,255,0.05);
          border-radius: 4px;
          font-size: 0.9rem;
          align-items: center;
        }
        .ingredient-line span:nth-child(2) {
          text-align: center;
          color: rgba(255,255,255,0.8);
        }
        .ingredient-line span:nth-child(3) {
          text-align: right;
          color: #10b981;
          font-weight: 500;
        }
      `;
      document.head.appendChild(style);
      
      // Zamykanie na klik t≈Ça
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          style.remove();
        }
      });
      
      document.body.appendChild(modal);
    }

    // Funkcja eksportu przepisu do PDF
    function exportRecipeToPDF(recipeId) {
	 console.log("PDF export started for recipe:", recipeId);
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) {
        showNotification('Przepis nie zosta≈Ç znaleziony');
        return;
      }
      
      const totalCost = calculateRecipeCost(recipe);
      const adjustedCost = recipe.yieldPercent ? totalCost / (recipe.yieldPercent / 100) : totalCost;
      
const totalWeightInRecipe = recipe.ingredients.reduce((sum, recipeIngredient) => {
  let weightInGrams = recipeIngredient.amount;
  if (recipeIngredient.unit === 'kg') weightInGrams *= 1000;
  else if (recipeIngredient.unit === 'l') weightInGrams *= 1000;
  else if (recipeIngredient.unit === 'ml') weightInGrams *= 1;
  else if (recipeIngredient.unit === 'szt') weightInGrams *= 50;
  
  return sum + weightInGrams;
}, 0);    
	 // Przygotuj HTML dla PDF
const ingredientsTable = recipe.ingredients.map(recipeIngredient => {
  const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
  if (!ingredient) return '<tr><td>Nieznany sk≈Çadnik</td><td>-</td><td>-</td><td>-</td></tr>';
  
  let cost = calculateIngredientCost(recipeIngredient.amount, recipeIngredient.unit, ingredient);
  
  // Oblicz procent sk≈Çadnika
  let weightInGrams = recipeIngredient.amount;
  if (recipeIngredient.unit === 'kg') weightInGrams *= 1000;
  else if (recipeIngredient.unit === 'l') weightInGrams *= 1000;
  else if (recipeIngredient.unit === 'ml') weightInGrams *= 1;
  else if (recipeIngredient.unit === 'szt') weightInGrams *= 50;
  
  return `<tr>
    <td>${ingredient.name}</td>
    <td>${recipeIngredient.amount} ${recipeIngredient.unit}</td>
 <td>${totalWeightInRecipe > 0 ? ((weightInGrams / totalWeightInRecipe) * 100).toFixed(1) : '0'}%</td>
    <td>${cost.toFixed(2)} z≈Ç</td>
  </tr>`;
}).join('');
      
      const pdfHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Przepis: ${recipe.name}</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
            .header { text-align: center; border-bottom: 3px solid #059669; padding-bottom: 20px; margin-bottom: 30px; }
            .recipe-title { color: #059669; font-size: 28px; margin: 0; font-weight: bold; }
            .recipe-subtitle { color: #666; margin: 10px 0; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
            .info-box { background: #f0f9f4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 15px; }
            .info-title { font-weight: bold; color: #059669; margin-bottom: 10px; }
            .cost-summary { background: #ecfccb; border: 2px solid #84cc16; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; }
            .cost-main { font-size: 24px; font-weight: bold; color: #365314; }
            .ingredients-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            .ingredients-table th, .ingredients-table td { border: 1px solid #d1d5db; padding: 10px; text-align: left; }
            .ingredients-table th { background: #f3f4f6; font-weight: bold; }
            .instructions { background: #f9fafb; border-radius: 8px; padding: 20px; margin: 20px 0; }
            .allergens { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
            .allergen-tag { background: #fef2f2; color: #dc2626; padding: 4px 8px; border-radius: 12px; font-size: 12px; border: 1px solid #fecaca; }
            .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1 class="recipe-title">${recipe.name}</h1>
            <div class="recipe-subtitle">ID: ${recipe.id} | Kategoria: ${recipe.category}</div>
            ${recipe.description ? `<p style="margin: 15px 0; font-style: italic;">${recipe.description}</p>` : ''}
          </div>
          
          <div class="info-grid">
            <div class="info-box">
              <div class="info-title">Podstawowe informacje</div>
              <div>Liczba porcji: <strong>${recipe.servings}</strong></div>
              <div>Wydajno≈õƒá: <strong>${recipe.yieldPercent || 95}%</strong></div>
              <div>Data utworzenia: <strong>${new Date(recipe.createdAt).toLocaleDateString('pl-PL')}</strong></div>
            </div>
            <div class="info-box">
              <div class="info-title">Kalkulacja koszt√≥w</div>
              <div>Koszt surowc√≥w: <strong>${totalCost.toFixed(2)} z≈Ç</strong></div>
              <div>Po uwzglƒôdnieniu wydajno≈õci: <strong>${adjustedCost.toFixed(2)} z≈Ç</strong></div>
              <div>Koszt na porcjƒô: <strong>${(adjustedCost / recipe.servings).toFixed(2)} z≈Ç</strong></div>
            </div>
          </div>
          
          <div class="cost-summary">
            <div class="cost-main">Ca≈Çkowity koszt: ${adjustedCost.toFixed(2)} z≈Ç</div>
            <div style="margin-top: 5px; color: #6b7280;">z uwzglƒôdnieniem ${recipe.yieldPercent || 95}% wydajno≈õci</div>
          </div>
          
          <h3 style="color: #059669; border-bottom: 2px solid #bbf7d0; padding-bottom: 5px;">Sk≈Çadniki</h3>
          <table class="ingredients-table">
            <thead>
              <tr>
                <th>Sk≈Çadnik</th>
                <th>Ilo≈õƒá</th>
				<th>Udzia≈Ç %</th>
                <th>Koszt</th>
              </tr>
            </thead>
            <tbody>
              ${ingredientsTable}
             <tr style="background: #ecfccb; font-weight: bold;">
  <td>RAZEM</td>
  <td>${recipe.yieldPercent || 95}% wydajno≈õƒá</td>
  <td>100%</td>
  <td>${adjustedCost.toFixed(2)} z≈Ç</td>
</tr>
            </tbody>
          </table>
          
          ${recipe.allergens && recipe.allergens.length > 0 ? `
            <h3 style="color: #059669; border-bottom: 2px solid #bbf7d0; padding-bottom: 5px;">Alergeny</h3>
            <div class="allergens">
              ${recipe.allergens.map(allergen => `<span class="allergen-tag">${allergen}</span>`).join('')}
            </div>
          ` : ''}
          
          ${recipe.instructions ? `
            <h3 style="color: #059669; border-bottom: 2px solid #bbf7d0; padding-bottom: 5px;">Instrukcje wykonania</h3>
            <div class="instructions">
              <div style="white-space: pre-line;">${recipe.instructions}</div>
            </div>
          ` : ''}
          
          <div class="footer">
            Dokument wygenerowany: ${new Date().toLocaleDateString('pl-PL')} ${new Date().toLocaleTimeString('pl-PL')}<br>
            System: Cukiernia Pro
          </div>
	<div class="pro-interface">
  <div class="pro-header">
    üìä CUKIERNIA PRO - ARKUSZ KALKULACYJNY
    <button onclick="toggleProMode()" style="float: right; background: #dc3545; color: white; border: none; padding: 8px 15px; margin-left: 15px;">üé® Tryb Standard</button>
  </div>
  
  <div class="pro-tabs">
    <button class="pro-tab active" onclick="showProTab('recipes')">üìã PRZEPISY</button>
    <button class="pro-tab" onclick="showProTab('ingredients')">ü•Ñ SK≈ÅADNIKI</button>
    <button class="pro-tab" onclick="showProTab('calculator')">üßÆ KALKULATOR</button>
    <button class="pro-tab" onclick="showProTab('settings')">‚öôÔ∏è USTAWIENIA</button>
  </div>
  
  <div class="pro-content" id="pro-content">
    <p>Wybierz zak≈Çadkƒô powy≈ºej...</p>
  </div>
</div>
        </body>
        </html>
      `;
      
      // Utw√≥rz nowe okno i wydrukuj jako PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(pdfHtml);
      printWindow.document.close();
      
      printWindow.onload = function() {
        printWindow.print();
        setTimeout(() => {
          printWindow.close();
        }, 1000);
      };
      
      showNotification(`Otwarto podglƒÖd PDF przepisu "${recipe.name}"`);
    }
function deleteIngredient(id) {
  if (!confirm("Na pewno chcesz usunƒÖƒá ten sk≈Çadnik?")) return;
  
  ingredients = ingredients.filter(ing => ing.id !== id);
  saveToStorage();
  loadIngredients();
  updateStatistics();
  showNotification("üóëÔ∏è Sk≈Çadnik usuniƒôty!");
}
    // Funkcje zarzƒÖdzania sk≈Çadnikami
    function loadIngredients() {
      const container = document.getElementById('ingredientsDisplay');
      const categories = [...new Set(ingredients.map(ing => ing.category))];
	  function deleteIngredient(id) {
  if (!confirm("Na pewno chcesz usunƒÖƒá ten sk≈Çadnik?")) return;
  
  ingredients = ingredients.filter(ing => ing.id !== id);
  saveToStorage();
  loadIngredients();
  updateStatistics();
  showNotification("üóëÔ∏è Sk≈Çadnik usuniƒôty!");
}


      
      let html = '';
      categories.forEach(category => {
        const categoryIngredients = ingredients.filter(ing => ing.category === category);
        
        html += `<div class="ingredient-category">${category}</div>`;
        
        categoryIngredients.forEach(ingredient => {
          html += `
            <div class="ingredient-db-item">
              <div>
                <div style="font-weight: 500; color: var(--text-color);">${ingredient.name}</div>
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                  ${ingredient.allergen ? `‚ö†Ô∏è ${ingredient.allergen}` : '‚úÖ Bez alergen√≥w'}
                </div>
              </div>
              <div style="text-align: right; display: flex; align-items: center; gap: 8px;">
                <div>
                  <div style="color: #10b981; font-weight: 600;">${ingredient.pricePerKg.toFixed(2)} z≈Ç/${ingredient.unit}</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">ID: ${ingredient.id}</div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="editIngredient(${ingredient.id})" style="margin: 0; padding: 4px 6px;">‚úèÔ∏è</button>
				<div class="ingredient-db-item">
  <span>${ingredient.name}</span>
  <button class="remove-btn" onclick="deleteIngredient(${ingredient.id})">üóëÔ∏è</button>
</div>

              </div>
            </div>
          `;
        });
      });
      
      container.innerHTML = html;
    }

    function showAddIngredient() {
      document.getElementById('addIngredientForm').style.display = 'block';
      document.getElementById('newIngredientName').focus();
    }

    function cancelAddIngredient() {
      document.getElementById('addIngredientForm').style.display = 'none';
      document.getElementById('newIngredientName').value = '';
      document.getElementById('newIngredientPrice').value = '';
      document.getElementById('newIngredientUnit').value = 'kg';
      document.getElementById('newIngredientCategory').value = 'MƒÖki';
      document.getElementById('newIngredientAllergen').value = '';
    }

    function saveNewIngredient() {
      console.log("Klikniƒôto Zapisz");
	  const name = document.getElementById('newIngredientName').value.trim();
      const price = parseFloat(document.getElementById('newIngredientPrice').value);
      const unit = document.getElementById('newIngredientUnit').value;
      const category = document.getElementById('newIngredientCategory').value;
      const allergen = document.getElementById('newIngredientAllergen').value;
      
      if (!name) {
        showNotification('Wpisz nazwƒô sk≈Çadnika');
        return;
      }
	  
      
      if (!price || price <= 0) {
        showNotification('Wpisz poprawnƒÖ cenƒô');
        return;
      }
      
      let newIngredient = {
		id: nextIngredientId++,
        name,
        pricePerKg: price,
        unit,
        category,
        allergen
      };
      
      ingredients.push(newIngredient);
      saveToStorage();
      loadIngredients();
      cancelAddIngredient();
      showNotification(`Sk≈Çadnik "${name}" dodany!`);
    }
	
	

    function editIngredient(ingredientId) {
    const ingredient = ingredients.find(ing => ing.id === ingredientId);
    if (!ingredient) return;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        box-sizing: border-box;
    `;
    
    // Pobierz aktualne kategorie dynamicznie
    const ingredientCategories = [...new Set(ingredients.map(ing => ing.category))];
    let categoryOptions = '';
    ingredientCategories.forEach(category => {
        const selected = ingredient.category === category ? 'selected' : '';
        categoryOptions += `<option value="${category}" ${selected}>${category}</option>`;
    });
    categoryOptions += '<option value="__new__">+ Dodaj nowƒÖ kategoriƒô</option>';
    
    modal.innerHTML = `
        <div style="
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border-color);
        ">
            <h3 style="margin: 0 0 20px 0; color: var(--primary-color);">Edytuj sk≈Çadnik</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 500;">Nazwa sk≈Çadnika:</label>
                <input type="text" id="editIngredientName" class="form-input" value="${ingredient.name}" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 500;">Cena za ${ingredient.unit}:</label>
                <input type="number" id="editIngredientPrice" class="form-input" value="${ingredient.pricePerKg}" step="0.01" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 500;">Kategoria:</label>
                <select id="editIngredientCategory" class="form-select" style="width: 100%;" onchange="handleCategoryChange(this)">
                    ${categoryOptions}
                </select>
                <input type="text" id="newCategoryInput" class="form-control" placeholder="Nazwa nowej kategorii" style="margin-top: 10px; display: none; width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 500;">Alergen (opcjonalnie):</label>
                <select id="editIngredientAllergen" class="form-select" style="width: 100%;">
                    <option value="">Brak alergenu</option>
                    <option value="gluten" ${ingredient.allergen === 'gluten' ? 'selected' : ''}>Gluten</option>
                    <option value="mleko" ${ingredient.allergen === 'mleko' ? 'selected' : ''}>Mleko</option>
                    <option value="jaja" ${ingredient.allergen === 'jaja' ? 'selected' : ''}>Jaja</option>
                    <option value="orzechy" ${ingredient.allergen === 'orzechy' ? 'selected' : ''}>Orzechy</option>
                    <option value="orzeszki ziemne" ${ingredient.allergen === 'orzeszki ziemne' ? 'selected' : ''}>Orzeszki ziemne</option>
                    <option value="soja" ${ingredient.allergen === 'soja' ? 'selected' : ''}>Soja</option>
                    <option value="ryby" ${ingredient.allergen === 'ryby' ? 'selected' : ''}>Ryby</option>
                    <option value="owoce morza" ${ingredient.allergen === 'owoce morza' ? 'selected' : ''}>Owoce morza</option>
                    <option value="sezam" ${ingredient.allergen === 'sezam' ? 'selected' : ''}>Sezam</option>
                    <option value="gorczyca" ${ingredient.allergen === 'gorczyca' ? 'selected' : ''}>Gorczyca</option>
                    <option value="seler" ${ingredient.allergen === 'seler' ? 'selected' : ''}>Seler</option>
                    <option value="siarczan" ${ingredient.allergen === 'siarczan' ? 'selected' : ''}>Dwutlenek siarki</option>
                    <option value="≈Çubin" ${ingredient.allergen === '≈Çubin' ? 'selected' : ''}>≈Åubin</option>
                    <option value="miƒôczaki" ${ingredient.allergen === 'miƒôczaki' ? 'selected' : ''}>Miƒôczaki</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeEditModal()" class="btn btn-secondary">Anuluj</button>
                <button onclick="saveEditedIngredient(${ingredientId})" class="btn">Zapisz</button>
            </div>
        </div>
    `;
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
    document.getElementById('editIngredientName').focus();
}
// Funkcja obs≈Çugi zmiany kategorii
function handleCategoryChange(select) {
    const newInput = document.getElementById('newCategoryInput');
    if (select.value === '__new__') {
        newInput.style.display = 'block';
        newInput.focus();
        newInput.setAttribute('required', 'true');
    } else {
        newInput.style.display = 'none';
        newInput.removeAttribute('required');
        newInput.value = '';
    }
}
function closeEditModal() {
    // Znajd≈∫ modal po r√≥≈ºnych kryteriach
    let modal = document.querySelector('[style*="z-index: 10000"]');
    
    // Je≈õli nie znajdzie, spr√≥buj innych selektor√≥w
    if (!modal) {
        modal = document.querySelector('.modal'); // je≈õli u≈ºywasz klasy modal
    }
    
    if (!modal) {
        modal = document.getElementById('editModal'); // je≈õli ma ID
    }
    
    // Usu≈Ñ modal
    if (modal) {
        modal.remove();
    }
}
function saveEditedIngredient(ingredientId) {
    const name = document.getElementById('editIngredientName').value.trim();
    const pricePerKg = parseFloat(document.getElementById('editIngredientPrice').value);
    const categorySelect = document.getElementById('editIngredientCategory');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const allergen = document.getElementById('editIngredientAllergen').value;
    
    if (!name) {
        alert('Podaj nazwƒô sk≈Çadnika!');
        return;
    }
    
    if (isNaN(pricePerKg) || pricePerKg <= 0) {
        alert('Podaj prawid≈ÇowƒÖ cenƒô!');
        return;
    }
    
    // Okre≈õl kategoriƒô - nowa lub istniejƒÖca
    let finalCategory;
    if (categorySelect.value === '__new__') {
        finalCategory = newCategoryInput.value.trim();
        if (!finalCategory) {
            alert('Podaj nazwƒô nowej kategorii!');
            return;
        }
    } else {
        finalCategory = categorySelect.value;
    }
    
    // Znajd≈∫ i zaktualizuj sk≈Çadnik
    const ingredientIndex = ingredients.findIndex(ing => ing.id === ingredientId);
    if (ingredientIndex !== -1) {
        ingredients[ingredientIndex] = {
            ...ingredients[ingredientIndex],
            name: name,
            pricePerKg: pricePerKg,
            category: finalCategory,
            allergen: allergen || null
        };
        
        // Zapisz do localStorage
        saveToStorage();
        
        // Od≈õwie≈º wy≈õwietlanie
        loadIngredients();
        updateStatistics();
        
        // Poka≈º powiadomienie
        showNotification(`‚úÖ Sk≈Çadnik "${name}" zosta≈Ç zaktualizowany!`);
        
        // Zamknij modal
        closeEditModal();
    }
}
	function showAddIngredientCategory() {
  const name = prompt("Podaj nazwƒô nowej kategorii sk≈Çadnika:");
  if (!name) return;
  if (ingredientCategories.includes(name)) {
    showNotification("‚ùó Taka kategoria ju≈º istnieje.");
    return;
  }
  function saveNewIngredient() {
  const name = document.getElementById('newIngredientName').value.trim();
  const price = parseFloat(document.getElementById('newIngredientPrice').value);
  const unit = document.getElementById('newIngredientUnit').value;
  const category = document.getElementById('newIngredientCategory').value;
  const allergen = document.getElementById('newIngredientAllergen').value;

  if (!name || isNaN(price) || !unit || !category) {
    showNotification('Uzupe≈Çnij wszystkie pola sk≈Çadnika!');
    return;
  }

  const newIngredient = {
    id: nextIngredientId++,
    name,
    pricePerKg: price,
    unit,
    category,
    allergen
  };

  ingredients.push(newIngredient);
  saveToStorage();
  loadIngredients();
  cancelAddIngredient();
  showNotification("‚úÖ Sk≈Çadnik dodany!");
}

  ingredientCategories.push(name);
  populateIngredientCategories();
  document.getElementById('newIngredientCategory').value = name;
  showNotification(`‚úÖ Dodano kategoriƒô "${name}"`);
}

    
   

    
    function displayFilteredRecipes(filtered, query) {
	 console.log('Wywo≈Çano displayFilteredRecipes z:', filtered.length, 'przepisami'); // DODAJ TO!
  const container = document.getElementById('recipeslist');
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="card" style="text-align: center; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üîç</div>
            <h3>Brak wynik√≥w</h3>
            <p style="color: rgba(255,255,255,0.6);">Nie znaleziono przepis√≥w${query ? ` dla "${query}"` : ''}</p>
          </div>
        `;
        return;
      }
      
console.log('Filtered recipes:', filtered);
      container.innerHTML = filtered.map(recipe => {
        const totalCost = calculateRecipeCost(recipe);
        const adjustedCost = recipe.yieldPercent ? totalCost / (recipe.yieldPercent / 100) : totalCost;
        const costPerServing = adjustedCost / recipe.servings;
		
        
        return `
          <div class="card recipe-card">
            <div class="recipe-header">
              <div style="display: flex; align-items: center;">
                <div class="recipe-icon">üßÅ</div>
                <div class="recipe-info">
                  <h3>${recipe.name}</h3>
                  <div class="recipe-meta">
                    <span class="meta-tag">${recipe.category}</span>
                    <span class="meta-tag">ID: ${recipe.id}</span>
                    <span class="meta-tag">${recipe.servings}p</span>
                    ${recipe.yieldPercent ? `<span class="meta-tag">${recipe.yieldPercent}% wydajno≈õƒá</span>` : ''}
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 6px;">
                <button class="btn btn-secondary btn-small" onclick="showRecipePreview(${recipe.id})" style="margin: 0; padding: 6px 8px;">üëÅÔ∏è</button>
                <button class="btn btn-secondary btn-small" onclick="editRecipe(${recipe.id})" style="margin: 0; padding: 6px 8px;">‚úèÔ∏è</button>
                <button class="btn btn-secondary btn-small" onclick="printRecipe(${recipe.id})" style="margin: 0; padding: 6px 8px;">üñ®Ô∏è</button>
<button class="btn btn-secondary btn-small" onclick="openRecipeInNewTab(${recipe.id})" style="margin: 0; padding: 6px 8px;">üëÅÔ∏è</button>
              </div>
            </div>
            
            <div style="margin: 12px 0;">
              <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-bottom: 4px;">${recipe.description || 'Brak opisu'}</div>
            </div>
            
            <div style="background: rgba(5, 150, 105, 0.1); border-radius: 8px; padding: 12px; border: 1px solid rgba(5, 150, 105, 0.2);">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                <div style="text-align: center;">
                  <div style="color: #f87171;">Koszt ca≈Çkowity: ${adjustedCost.toFixed(2)} z≈Ç</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #10b981;">Koszt/porcja: ${costPerServing.toFixed(2)} z≈Ç</div>
                </div>
              </div>
            </div>
            
            ${recipe.allergens && recipe.allergens.length > 0 ? `
              <div style="margin-top: 8px;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Alergeny:</div>
                <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px;">
                  ${recipe.allergens.map(allergen => `<span style="background: rgba(220, 38, 38, 0.2); color: #fca5a5; padding: 2px 6px; border-radius: 10px; font-size: 0.65rem;">${allergen}</span>`).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
	  
    }

    function searchIngredients(query) {
      if (!query) {
        loadIngredients();
        return;
      }
      
      const filtered = ingredients.filter(ing => 
        ing.name.toLowerCase().includes(query.toLowerCase()) ||
        ing.category.toLowerCase().includes(query.toLowerCase())
      );
      
      displayFilteredIngredients(filtered, query);
    }

function displayFilteredIngredients(filtered, query) {
    const container = document.getElementById('ingredientsDisplay');
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="card" style="text-align: center; padding: 40px;">
                <div style="font-size: 1rem; margin-bottom: 16px;">üîç</div>
                <h3>Brak wynik√≥w</h3>
                <p>Nie znaleziono sk≈Çadnik√≥w dla "${query}"</p>
            </div>`;
        return;
    }

    const categories = [...new Set(filtered.map(ing => ing.category))];
    let html = '';

    categories.forEach(category => {
        const categoryIngredients = filtered.filter(ing => ing.category === category);
        
        html += `<div class="ingredient-category">${category}</div>`;
        
        categoryIngredients.forEach(ingredient => {
            html += `
                <div class="ingredient-item">
                    <div>
                        <div style="font-weight: 500; color: var(--text-color);">${ingredient.name}</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                            ${ingredient.allergen ? '‚ö†Ô∏è ' + ingredient.allergen : '‚úÖ Bez alergenu'}
                        </div>
                    </div>
                    <div style="text-align: right; display: flex; align-items: center; gap: 5px;">
                        <div>
                            <div style="color: #10b981; font-weight: 600;">${ingredient.pricePerKg.toFixed(2)} z≈Ç/${ingredient.unit}</div>
                            <div style="font-size: 0.75em; color: rgba(255,255,255,0.5);">ID: ${ingredient.id}</div>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="editIngredient(${ingredient.id})" style="margin: 0; padding: 4px 6px;">‚úèÔ∏è</button>
                    </div>
                </div>`;
        });
    });

    container.innerHTML = html;
}

    // Kalkulator produkcji
    function searchRecipesForCalculator() {
      const query = document.getElementById('recipeSearch').value.toLowerCase();
      const resultsDiv = document.getElementById('recipeSearchResults');
      
      if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }
      
      const filtered = recipes.filter(recipe => 
        recipe.name.toLowerCase().includes(query)
      ).slice(0, 5);
      
      if (filtered.length === 0) {
        resultsDiv.style.display = 'none';
        return;
      }
      
      const html = filtered.map(recipe => `
        <div class="suggestion-item" onclick="selectRecipeForCalculator(${recipe.id}, '${recipe.name}')">
          <div style="font-weight: 500;">${recipe.name}</div>
          <div style="font-size: 0.8rem; opacity: 0.7;">ID: ${recipe.id} ‚Ä¢ ${recipe.category}</div>
        </div>
      `).join('');
      
      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }

    function selectRecipeForCalculator(recipeId, recipeName) {
      selectedRecipeForCalculator = recipes.find(r => r.id === recipeId);
      
      document.getElementById('recipeSearch').value = recipeName;
      document.getElementById('recipeSearchResults').style.display = 'none';
      
      const infoDiv = document.getElementById('selectedRecipeInfo');
      const nameDiv = document.getElementById('selectedRecipeName');
      const detailsDiv = document.getElementById('selectedRecipeDetails');
      
      if (selectedRecipeForCalculator) {
        const totalCost = calculateRecipeCost(selectedRecipeForCalculator);
        const totalWeight = calculateRecipeWeight(selectedRecipeForCalculator);
        
        nameDiv.textContent = selectedRecipeForCalculator.name;
        detailsDiv.innerHTML = `
          ID: ${selectedRecipeForCalculator.id} ‚Ä¢ ${selectedRecipeForCalculator.category} ‚Ä¢ 
          Waga: ${totalWeight.toFixed(0)}g ‚Ä¢ Koszt: ${totalCost.toFixed(2)} z≈Ç
        `;
        
        infoDiv.style.display = 'block';
      }
    }

    function calculateRecipeWeight(recipe) {
      if (!recipe.ingredients) return 0;
      
      return recipe.ingredients.reduce((total, recipeIngredient) => {
        const amount = recipeIngredient.amount;
        const unit = recipeIngredient.unit;
        
        let weightInGrams = 0;
        if (unit === 'kg') weightInGrams = amount * 1000;
        else if (unit === 'g') weightInGrams = amount;
        else if (unit === 'l') weightInGrams = amount * 1000;
        else if (unit === 'ml') weightInGrams = amount;
        else if (unit === 'szt') weightInGrams = amount * 50;
        
        return total + weightInGrams;
      }, 0);
    }

    function calculateByWeightGrams() {
      if (!selectedRecipeForCalculator) {
        showNotification('Najpierw wybierz przepis');
        return;
      }
      
      const targetWeight = parseFloat(document.getElementById('targetWeightGrams').value);
      if (!targetWeight || targetWeight <= 0) {
        document.getElementById('proportionResult').style.display = 'none';
        return;
      }
      
      const originalWeight = calculateRecipeWeight(selectedRecipeForCalculator);
      const multiplier = targetWeight / originalWeight;
      
      document.getElementById('originalWeightDisplay').textContent = `${originalWeight.toFixed(0)}g`;
      document.getElementById('targetWeightDisplay').textContent = `${targetWeight.toFixed(0)}g`;
      document.getElementById('multiplierDisplay').textContent = `√ó${multiplier.toFixed(2)}`;
      
      const scaledIngredients = selectedRecipeForCalculator.ingredients.map(recipeIngredient => {
        const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
        const scaledAmount = recipeIngredient.amount * multiplier;
        
        return {
          name: ingredient ? ingredient.name : 'Nieznany sk≈Çadnik',
          scaledAmount: scaledAmount,
          unit: recipeIngredient.unit,
          ingredient: ingredient
        };
      });
      
      const listHtml = scaledIngredients.map(item => {
        const cost = item.ingredient ? calculateIngredientCost(item.scaledAmount, item.unit, item.ingredient) : 0;
        
        return `
          <div class="cost-line">
            <span>${item.name}</span>
            <span>${item.scaledAmount.toFixed(item.scaledAmount < 1 ? 2 : 1)} ${item.unit} (${cost.toFixed(2)} z≈Ç)</span>
          </div>
        `;
      }).join('');
      
      const totalCost = scaledIngredients.reduce((sum, item) => {
        return sum + (item.ingredient ? calculateIngredientCost(item.scaledAmount, item.unit, item.ingredient) : 0);
      }, 0);
      
      const yieldPercent = selectedRecipeForCalculator.yieldPercent || 95;
      const adjustedCost = totalCost / (yieldPercent / 100);
      
      const finalHtml = listHtml + `
        <div class="cost-line">
          <span><strong>RAZEM (${yieldPercent}% wydajno≈õƒá)</strong></span>
          <span><strong>${adjustedCost.toFixed(2)} z≈Ç</strong></span>
        </div>
      `;
      
      document.getElementById('scaledIngredientsList').innerHTML = finalHtml;
      document.getElementById('proportionResult').style.display = 'block';
    }

    function calculateIngredientCost(amount, unit, ingredient) {
      let cost = 0;
      if (unit === 'kg') cost = amount * ingredient.pricePerKg;
      else if (unit === 'g') cost = (amount / 1000) * ingredient.pricePerKg;
      else if (unit === 'l') cost = amount * ingredient.pricePerKg;
      else if (unit === 'ml') cost = (amount / 1000) * ingredient.pricePerKg;
      else if (unit === 'szt') cost = (amount * 50 / 1000) * ingredient.pricePerKg;
      
      return cost;
    }

    function exportScaledRecipeToPDF() {
      if (!selectedRecipeForCalculator) {
        showNotification('Brak przepisu do eksportu');
        return;
      }
      
      const targetWeight = parseFloat(document.getElementById('targetWeightGrams').value);
      if (!targetWeight) {
        showNotification('Wprowad≈∫ docelowƒÖ wagƒô');
        return;
      }
      
      const originalWeight = calculateRecipeWeight(selectedRecipeForCalculator);
      const multiplier = targetWeight / originalWeight;
      
      const scaledIngredients = selectedRecipeForCalculator.ingredients.map(recipeIngredient => {
        const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
        const scaledAmount = recipeIngredient.amount * multiplier;
        
        return {
          name: ingredient ? ingredient.name : 'Nieznany sk≈Çadnik',
          amount: scaledAmount,
          unit: recipeIngredient.unit
        };
      });
      
      const totalCost = scaledIngredients.reduce((sum, item) => {
        const ingredient = ingredients.find(ing => ing.name === item.name);
        return sum + (ingredient ? calculateIngredientCost(item.amount, item.unit, ingredient) : 0);
      }, 0);
      
      const yieldPercent = selectedRecipeForCalculator.yieldPercent || 95;
      const adjustedCost = totalCost / (yieldPercent / 100);
      
      // Oblicz procenty sk≈Çadnik√≥w i koszty
      const scaledIngredientsWithDetails = scaledIngredients.map(item => {
        const ingredient = ingredients.find(ing => ing.name === item.name);
        const cost = ingredient ? calculateIngredientCost(item.amount, item.unit, ingredient) : 0;
        
        // Konwertuj na gramy dla obliczenia procent√≥w
        let weightInGrams = item.amount;
        if (item.unit === 'kg') weightInGrams *= 1000;
        else if (item.unit === 'l') weightInGrams *= 1000;
        else if (item.unit === 'ml') weightInGrams *= 1;
        else if (item.unit === 'szt') weightInGrams *= 50;
        
        return {
          ...item,
          cost: cost,
          weightInGrams: weightInGrams
        };
      });
      
      const totalWeight = scaledIngredientsWithDetails.reduce((sum, item) => sum + item.weightInGrams, 0);
      
      const ingredientsTable = scaledIngredientsWithDetails.map(item => {
        const percent = totalWeight > 0 ? (item.weightInGrams / totalWeight * 100) : 0;
        return `
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">${item.name}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.amount.toFixed(1)}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${item.unit}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;">${percent.toFixed(1)}%</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.cost.toFixed(2)} z≈Ç</td>
          </tr>
        `;
      }).join('');
      
      const allergens = selectedRecipeForCalculator.allergens && selectedRecipeForCalculator.allergens.length > 0 
        ? selectedRecipeForCalculator.allergens.join(', ') 
        : 'brak';
      
      const pdfHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Karta Produkcji - ${selectedRecipeForCalculator.name}</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              max-width: 210mm; 
              margin: 0 auto; 
              padding: 20mm; 
              line-height: 1.4; 
              font-size: 12pt;
            }
            .header { 
              display: grid; 
              grid-template-columns: 1fr 1fr; 
              gap: 20px; 
              margin-bottom: 25px; 
              border-bottom: 2px solid #333; 
              padding-bottom: 15px; 
            }
            .header-section h3 { 
              margin: 0 0 10px 0; 
              font-size: 14pt; 
              text-transform: uppercase; 
              border-bottom: 1px solid #ccc; 
              padding-bottom: 5px; 
            }
            .header-section p { margin: 3px 0; }
            .ingredients-table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 20px 0; 
              font-size: 11pt;
            }
            .ingredients-table th { 
              background: #f5f5f5; 
              border: 1px solid #333; 
              padding: 10px 8px; 
              text-align: center; 
              font-weight: bold; 
              text-transform: uppercase;
            }
            .ingredients-table td { 
              border: 1px solid #ddd; 
              padding: 8px; 
            }
            .total-row { 
              background: #f0f0f0; 
              font-weight: bold; 
            }
            .total-row td { 
              border: 2px solid #333 !important; 
            }
            .section { 
              margin: 20px 0; 
              padding: 15px; 
              border: 1px solid #ddd; 
            }
            .section h4 { 
              margin: 0 0 10px 0; 
              text-transform: uppercase; 
              font-size: 12pt; 
              border-bottom: 1px solid #ccc; 
              padding-bottom: 5px; 
            }
            .footer { 
              margin-top: 30px; 
              text-align: center; 
              font-size: 10pt; 
              color: #666; 
              border-top: 1px solid #ccc; 
              padding-top: 15px; 
            }
			
          </style>
        </head>
        <body>
          <div class="header">
            <div class="header-section">
              <h3>Informacje podstawowe</h3>
              <p><strong>Nazwa:</strong> ${selectedRecipeForCalculator.name}</p>
              <p><strong>Kategoria:</strong> ${selectedRecipeForCalculator.category}</p>
              <p><strong>Ca≈Çkowita waga sk≈Çadnik√≥w:</strong> ${totalWeight.toFixed(0)} g</p>
              <p><strong>Wydajno≈õƒá:</strong> ${yieldPercent}%</p>
            </div>
            <div class="header-section">
              <h3>Kalkulacja koszt√≥w</h3>
              <p><strong>Koszt sk≈Çadnik√≥w:</strong> ${totalCost.toFixed(2)} z≈Ç</p>
              <p><strong>Koszt po uwzglƒôdnieniu wydajno≈õci:</strong> ${adjustedCost.toFixed(2)} z≈Ç</p>
              <p><strong>Data:</strong> ${new Date().toLocaleDateString('pl-PL')}</p>
            </div>
          </div>
          
          <table class="ingredients-table">
            <thead>
              <tr>
                <th style="width: 35%;">SK≈ÅADNIK</th>
                <th style="width: 15%;">ILO≈öƒÜ</th>
                <th style="width: 15%;">JEDNOSTKA</th>
                <th style="width: 15%;">UDZIA≈Å WAGOWY</th>
                <th style="width: 20%;">KOSZT</th>
              </tr>
            </thead>
            <tbody>
              ${ingredientsTable}
              <tr class="total-row">
                <td><strong>RAZEM</strong></td>
                <td style="text-align: center;"><strong>${totalWeight.toFixed(0)}</strong></td>
                <td style="text-align: center;"><strong>g</strong></td>
                <td style="text-align: center;"><strong>100.0%</strong></td>
                <td style="text-align: right;"><strong>${adjustedCost.toFixed(2)} z≈Ç</strong></td>
              </tr>
            </tbody>
          </table>
          
          <div class="section">
            <h4>Alergeny</h4>
            <p><strong>Zawiera:</strong> ${allergens}</p>
          </div>
          
          ${selectedRecipeForCalculator.instructions ? `
            <div class="section">
              <h4>Instrukcje produkcji</h4>
              <p style="white-space: pre-line;">${selectedRecipeForCalculator.instructions}</p>
            </div>
          ` : ''}
          
          <div class="footer">
            <p>Karta odpowiedzialnego</p>
            <p>Wygenerowano: ${new Date().toLocaleDateString('pl-PL')}, ${new Date().toLocaleTimeString('pl-PL')}</p>
          </div>
        </body>
        </html>
      `;
      
      // Utw√≥rz nowe okno i wydrukuj jako PDF
      const printWindow = window.open('', '_blank');
      printWindow.document.write(pdfHtml);
      printWindow.document.close();
      
      printWindow.onload = function() {
        printWindow.print();
        setTimeout(() => {
          printWindow.close();
        }, 1000);
      };
      
      showNotification('Karta produkcji wyeksportowana!');
    }

    // Funkcja wy≈õwietlania spis√≥w ID
    function showIdList(type) {
      const container = document.getElementById('idListContainer');
      const content = document.getElementById('idListContent');
      const recipesBtn = document.getElementById('showRecipesBtn');
      const ingredientsBtn = document.getElementById('showIngredientsBtn');
      
      // Reset przycisk√≥w
      recipesBtn.classList.remove('btn');
      recipesBtn.classList.add('btn', 'btn-secondary');
      ingredientsBtn.classList.remove('btn');
      ingredientsBtn.classList.add('btn', 'btn-secondary');
      
      if (type === 'recipes') {
        recipesBtn.classList.remove('btn-secondary');
        recipesBtn.classList.add('btn');
        
        if (recipes.length === 0) {
          content.innerHTML = `
            <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">
              Brak przepis√≥w
            </div>
          `;
        } else {
          const recipesList = recipes.map(recipe => `
            <div style="
              display: grid; 
              grid-template-columns: 80px 1fr 100px 80px; 
              gap: 12px; 
              padding: 8px 12px; 
              background: rgba(255,255,255,0.05); 
              border-radius: 6px; 
              margin-bottom: 4px;
              align-items: center;
            ">
              <div style="color: var(--primary-color); font-weight: 600;">ID: ${recipe.id}</div>
              <div style="color: var(--text-color);">${recipe.name}</div>
              <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">${recipe.category}</div>
              <div style="display: flex; gap: 4px;">
                <button class="btn btn-secondary btn-small" onclick="showRecipePreview(${recipe.id})" style="margin: 0; padding: 2px 4px; font-size: 0.75rem;">üëÅÔ∏è</button>
                <button class="btn btn-secondary btn-small" onclick="editRecipe(${recipe.id})" style="margin: 0; padding: 2px 4px; font-size: 0.75rem;">‚úèÔ∏è</button>
              </div>
            </div>
          `).join('');
          
          content.innerHTML = `
            <div style="margin-bottom: 12px;">
              <div style="
                display: grid; 
                grid-template-columns: 80px 1fr 100px 80px; 
                gap: 12px; 
                padding: 8px 12px; 
                font-weight: 600; 
                color: var(--secondary-color);
                border-bottom: 1px solid rgba(5, 150, 105, 0.3);
                margin-bottom: 8px;
              ">
                <div>ID</div>
                <div>Nazwa</div>
                <div>Kategoria</div>
                <div>Akcje</div>
              </div>
              ${recipesList}
            </div>
            <div style="text-align: center; margin-top: 12px; font-size: 0.9rem; color: rgba(255,255,255,0.6);">
              ≈ÅƒÖcznie: ${recipes.length} przepis√≥w
            </div>
          `;
        }
      } else if (type === 'ingredients') {
        ingredientsBtn.classList.remove('btn-secondary');
        ingredientsBtn.classList.add('btn');
        
        if (ingredients.length === 0) {
          content.innerHTML = `
            <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">
              Brak sk≈Çadnik√≥w
            </div>
          `;
        } else {
          const ingredientsList = ingredients.map(ingredient => `
            <div style="
              display: grid; 
              grid-template-columns: 60px 1fr 80px 100px 80px; 
              gap: 12px; 
              padding: 8px 12px; 
              background: rgba(255,255,255,0.05); 
              border-radius: 6px; 
              margin-bottom: 4px;
              align-items: center;
            ">
              <div style="color: var(--primary-color); font-weight: 600;">ID: ${ingredient.id}</div>
              <div style="color: var(--text-color);">${ingredient.name}</div>
              <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">${ingredient.category}</div>
              <div style="color: #10b981; font-size: 0.85rem;">${ingredient.pricePerKg.toFixed(2)} z≈Ç/${ingredient.unit}</div>
              <div>
                <button class="btn btn-secondary btn-small" onclick="editIngredient(${ingredient.id})" style="margin: 0; padding: 2px 4px; font-size: 0.75rem;">‚úèÔ∏è</button>
              </div>
            </div>
          `).join('');
          
          content.innerHTML = `
            <div style="margin-bottom: 12px;">
              <div style="
                display: grid; 
                grid-template-columns: 60px 1fr 80px 100px 80px; 
                gap: 12px; 
                padding: 8px 12px; 
                font-weight: 600; 
                color: var(--secondary-color);
                border-bottom: 1px solid rgba(5, 150, 105, 0.3);
                margin-bottom: 8px;
              ">
                <div>ID</div>
                <div>Nazwa</div>
                <div>Kategoria</div>
                <div>Cena</div>
                <div>Akcje</div>
              </div>
              ${ingredientsList}
            </div>
            <div style="text-align: center; margin-top: 12px; font-size: 0.9rem; color: rgba(255,255,255,0.6);">
              ≈ÅƒÖcznie: ${ingredients.length} sk≈Çadnik√≥w
            </div>
          `;
        }
      }
      
      container.style.display = 'block';
    }
	function searchRecipes(query) {
  if (!query) {
    loadRecipes();
    return;
  }
  
  const queryLower = query.toLowerCase();
  
  const filtered = recipes.filter(recipe => {
    // Sprawd≈∫ nazwƒô
    if (recipe.name.toLowerCase().includes(queryLower)) return true;
    
    // Sprawd≈∫ kategoriƒô
    if (recipe.category.toLowerCase().includes(queryLower)) return true;
    
    // Sprawd≈∫ opis
    if (recipe.description && recipe.description.toLowerCase().includes(queryLower)) return true;
    
    // Sprawd≈∫ instrukcje
    if (recipe.instructions && recipe.instructions.toLowerCase().includes(queryLower)) return true;
    
    // Sprawd≈∫ sk≈Çadniki
    for (let recipeIngredient of recipe.ingredients) {
      const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
      if (ingredient && ingredient.name.toLowerCase().includes(queryLower)) return true;
    }
    
    return false;
  });
  
  // Poka≈º wyniki
  const originalRecipes = [...recipes];
  recipes = filtered;
  loadRecipes();
  recipes = originalRecipes;
}

function createIngredientRow(name = '', amount = '', unit = 'kg', id = '') {
  const row = document.createElement('div');
  row.className = 'ingredient-item';
  row.innerHTML = `
    <div style="position: relative; flex: 2;">
      <input type="text" class="form-input ingredient-input" placeholder="Wpisz sk≈Çadnik..."
             value="${name}" data-ingredient-id="${id}"
             oninput="showIngredientSuggestions(this)"
             onfocus="showIngredientSuggestions(this)"
             onblur="hideIngredientSuggestions(this)" />
      <div class="ingredient-suggestions" style="display: none;"></div>
    </div>
    <input type="number" class="form-input amount-input" placeholder="Ilo≈õƒá" value="${amount}" step="0.01" oninput="calculateRecipeCostLive()" />
    <select class="form-select unit-select" onchange="calculateRecipeCostLive()">
      <option value="kg" ${unit === 'kg' ? 'selected' : ''}>kg</option>
      <option value="g" ${unit === 'g' ? 'selected' : ''}>g</option>
      <option value="l" ${unit === 'l' ? 'selected' : ''}>l</option>
      <option value="ml" ${unit === 'ml' ? 'selected' : ''}>ml</option>
      <option value="szt" ${unit === 'szt' ? 'selected' : ''}>szt</option>
    </select>
    <button class="remove-btn" onclick="removeIngredient(this)">üóëÔ∏è</button>
  `;
  return row;
}
function showProTab(tab) {
  // Zmie≈Ñ aktywnƒÖ zak≈Çadkƒô
  document.querySelectorAll('.pro-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  const content = document.getElementById('pro-content');
  
  if (tab === 'recipes') {
    loadProRecipes();
  } else if (tab === 'ingredients') {
    loadProIngredients();
  } else if (tab === 'calculator') {
    loadProCalculator();
  } else if (tab === 'settings') {
    loadProSettings();
  }
}

function loadProRecipes() {
  const content = document.getElementById('pro-content');
  content.innerHTML = `
    <div style="background: #f8f9fa; padding: 8px; border-bottom: 2px solid #000; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <button onclick="addNewRecipePro()" style="background: #28a745; color: white; border: none; padding: 6px 12px; font-size: 11px; margin-right: 5px;">+ NOWY</button>
        <button onclick="exportAllRecipesPDF()" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 11px;">üìä EKSPORT PDF</button>
      </div>
      <div style="font-weight: bold;">
        ≈ÅƒÖcznie przepis√≥w: <span style="color: #007bff;">${recipes.length}</span>
      </div>
    </div>
    
    <table class="pro-table" style="width: 100%; border-collapse: collapse; margin: 0;">
      <thead>
        <tr style="background: #e9ecef;">
          <th style="border: 1px solid #666; padding: 8px; width: 40px; text-align: center;">#</th>
          <th style="border: 1px solid #666; padding: 8px; width: 250px;">NAZWA PRZEPISU</th>
          <th style="border: 1px solid #666; padding: 8px; width: 120px;">KATEGORIA</th>
          <th style="border: 1px solid #666; padding: 8px; width: 80px;">PORCJE</th>
          <th style="border: 1px solid #666; padding: 8px; width: 100px;">KOSZT TOTAL</th>
          <th style="border: 1px solid #666; padding: 8px; width: 100px;">KOSZT/PORCJA</th>
          <th style="border: 1px solid #666; padding: 8px; width: 150px;">AKCJE</th>
        </tr>
      </thead>
      <tbody id="pro-recipes-tbody">
      </tbody>
    </table>
  `;
  
  // Wype≈Çnij tabelƒô przepisami
  const tbody = document.getElementById('pro-recipes-tbody');
  tbody.innerHTML = '';
  
  recipes.forEach((recipe, index) => {
    const totalCost = calculateRecipeCost(recipe);
    const costPerServing = totalCost / recipe.servings;
    
    const row = document.createElement('tr');
    row.style.cursor = 'pointer';
    row.ondblclick = () => viewRecipeDetailed(recipe.id);
    
    // Naprzemienne kolory wierszy
    if (index % 2 === 0) {
      row.style.backgroundColor = '#ffffff';
    } else {
      row.style.backgroundColor = '#f8f9fa';
    }
    
    row.innerHTML = `
      <td style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold;">${index + 1}</td>
      <td style="border: 1px solid #ccc; padding: 6px;"><strong>${recipe.name}</strong></td>
      <td style="border: 1px solid #ccc; padding: 6px; font-size: 10px;">${recipe.category || '-'}</td>
      <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${recipe.servings}</td>
      <td style="border: 1px solid #ccc; padding: 6px; text-align: right; font-weight: bold; color: #007bff;">${totalCost.toFixed(2)} z≈Ç</td>
      <td style="border: 1px solid #ccc; padding: 6px; text-align: right;">${costPerServing.toFixed(2)} z≈Ç</td>
      <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">
        <button onclick="viewRecipeDetailed(${recipe.id})" style="font-size: 9px; padding: 2px 6px; margin: 1px; background: #17a2b8; color: white; border: none;">üëÅ SZCZEG√ì≈ÅY</button>
        <button onclick="exportRecipeToPDF(${recipe.id})" style="font-size: 9px; padding: 2px 6px; margin: 1px; background: #6c757d; color: white; border: none;">üìÑ PDF</button>
        <button onclick="deleteRecipe(${recipe.id})" style="font-size: 9px; padding: 2px 6px; margin: 1px; background: #dc3545; color: white; border: none;">üóë DEL</button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

// Funkcje-placeholder dla innych zak≈Çadek
function loadProIngredients() {
  const content = document.getElementById('pro-content');
  content.innerHTML = '<div style="background: #f8f9fa; padding: 8px; border-bottom: 2px solid #000; margin-bottom: 10px;"><h2>ü•Ñ SK≈ÅADNIKI - BAZA DANYCH</h2><p>Liczba sk≈Çadnik√≥w: <strong>' + ingredients.length + '</strong></p><button onclick="addNewIngredient()" style="background: #28a745; color: white; border: none; padding: 6px 12px; font-size: 11px;">+ NOWY SK≈ÅADNIK</button></div><div style="background: white; border: 1px solid #ccc; padding: 15px; max-height: 400px; overflow-y: auto;"><h3>Lista sk≈Çadnik√≥w:</h3>' + ingredients.map(function(ing, index) {
    const name = ing.name || ing.nazwa || ing.ingredient || 'Bez nazwy';
    const price = ing.price || ing.cost || ing.cena || 0;
    const unit = ing.unit || ing.jednostka || 'szt';
    const category = ing.category || ing.kategoria || 'Brak kategorii';
    
    return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;"><div><strong>' + name + '</strong><br><small>' + unit + ' | ' + Number(price).toFixed(2) + ' z≈Ç | ' + category + '</small></div><div><button onclick="editIngredient(' + (ing.id || index) + ')" style="font-size: 9px; padding: 4px 8px; margin: 2px; background: #17a2b8; color: white; border: none;">‚úèÔ∏è EDIT</button><button onclick="deleteIngredient(' + (ing.id || index) + ')" style="font-size: 9px; padding: 4px 8px; margin: 2px; background: #dc3545; color: white; border: none;">üóë DEL</button></div></div>';
  }).join('') + '</div>';
}
// FUNKCJE KALKULATORA - POPRAWIONE NAWIASY
let calculationItems = [];

function addToCalculation() {
  const ingredientIndex = document.getElementById('calc-ingredient').value;
  const amount = parseFloat(document.getElementById('calc-amount').value);
  
  if (ingredientIndex === '' || !amount) {
    showNotification('Wybierz sk≈Çadnik i podaj ilo≈õƒá!');
    return;
  }
  
  const ingredient = ingredients[ingredientIndex];
  if (!ingredient) return;
  
  // Uniwersalne nazwy p√≥l
  const name = ingredient.name || ingredient.nazwa || ingredient.ingredient || 'Bez nazwy';
  const price = ingredient.price || ingredient.cost || ingredient.cena || 0;
  const unit = ingredient.unit || ingredient.jednostka || 'szt';
  
  const cost = amount * Number(price);
  
  calculationItems.push({
    id: Date.now(),
    name: name,
    unit: unit,
    amount: amount,
    pricePerUnit: Number(price),
    cost: cost
  });
  
  document.getElementById('calc-amount').value = '';
  updateCalculation();
  showNotification('Sk≈Çadnik dodany do kalkulacji');
}

function updateCalculation() {
  const servings = parseInt(document.getElementById('calc-servings').value) || 1;
  
  let html = '';
  let totalCost = 0;
  
  calculationItems.forEach(function(item) {
    totalCost += item.cost;
    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;">';
    html += '<span>';
    html += '<strong>' + item.name + '</strong><br>';
    html += '<small>' + item.amount + ' ' + item.unit + ' √ó ' + item.pricePerUnit.toFixed(2) + ' z≈Ç</small>';
    html += '</span>';
    html += '<span style="font-weight: bold; color: #007bff;">' + item.cost.toFixed(2) + ' z≈Ç</span>';
    html += '<button onclick="removeFromCalculation(' + item.id + ')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; font-size: 10px;">‚úï</button>';
    html += '</div>';
  });
  
  if (html === '') {
    html = '<p style="color: #666;">Dodaj sk≈Çadniki aby zobaczyƒá koszty...</p>';
  }
  
  document.getElementById('calculation-results').innerHTML = html;
  document.getElementById('total-cost').textContent = totalCost.toFixed(2) + ' z≈Ç';
  document.getElementById('cost-per-serving').textContent = (totalCost / servings).toFixed(2) + ' z≈Ç';
}

function removeFromCalculation(itemId) {
  calculationItems = calculationItems.filter(function(item) {
    return item.id !== itemId;
  });
  updateCalculation();
}

function clearCalculation() {
  calculationItems = [];
  updateCalculation();
  showNotification('Kalkulacja wyczyszczona');
}

function loadProSettings() {
  document.getElementById('pro-content').innerHTML = '<h2>‚öôÔ∏è USTAWIENIA - TRYB PRO</h2><p>W przygotowaniu...</p>';
}

function addNewRecipePro() {
  showNotification('Dodawanie nowego przepisu - w przygotowaniu');
}

function exportAllRecipesPDF() {
  showNotification('Eksport wszystkich przepis√≥w - w przygotowaniu');
}

function viewRecipeDetailed(recipeId) {
  showNotification('Szczeg√≥≈Çowy widok przepisu - w przygotowaniu');
}
function showProTab(tab) {
  // Zmie≈Ñ aktywnƒÖ zak≈Çadkƒô
  document.querySelectorAll('.pro-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[onclick="showProTab('${tab}')"]`).classList.add('active');
  
  const content = document.getElementById('pro-content');
  
  if (tab === 'recipes') {
    loadProRecipes();
  } else if (tab === 'ingredients') {
    loadProIngredients();
  } else if (tab === 'calculator') {
    loadProCalculator();
  }
}

function loadProCalculator() {
  const content = document.getElementById('pro-content');
  
  var allRows = '';
  for (var i = 0; i < 12; i++) {
    allRows += '<div style="display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid #ccc;">';
    allRows += '<div style="padding: 4px; border-right: 1px solid #ccc;">';
    allRows += '<input type="text" id="ingredient-' + i + '" style="width: 100%; border: none; font-size: 11px; background: transparent;" placeholder="Sk≈Çadnik ' + (i + 1) + '">';
    allRows += '</div>';
    allRows += '<div style="padding: 4px; border-right: 1px solid #ccc;">';
    allRows += '<input type="number" id="grams-' + i + '" style="width: 100%; border: none; font-size: 11px; background: transparent; text-align: center;" placeholder="0" onchange="calculateAllPercentages()">';
    allRows += '</div>';
    allRows += '<div style="padding: 4px;">';
    allRows += '<input type="text" id="percent-' + i + '" style="width: 100%; border: none; font-size: 11px; background: transparent; text-align: center;" readonly>';
    allRows += '</div>';
    allRows += '</div>';
  }
  
  content.innerHTML = '<div style="background: white; padding: 20px; font-family: Arial, sans-serif; border: 2px solid #000;">' +
    
    '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">' +
    '<div>' +
    '<label style="font-weight: bold; font-size: 11px; margin-bottom: 3px; display: block;">NAZWA PRZEPISU:</label>' +
    '<input type="text" id="recipe-name" style="width: 100%; padding: 4px; border: 1px solid #000; font-size: 11px;" placeholder="Wpisz nazwƒô...">' +
    '</div>' +
    '<div>' +
    '<label style="font-weight: bold; font-size: 11px; margin-bottom: 3px; display: block;">MASA DOCELOWA:</label>' +
    '<input type="number" id="target-mass" style="width: 80%; padding: 4px; border: 1px solid #000; font-size: 11px;" placeholder="1000" onchange="calculateAllPercentages()"> g' +
    '</div>' +
    '<div>' +
    '<button onclick="loadRecipeData()" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 11px;">üìã ZA≈ÅADUJ</button>' +
    '</div>' +
    '</div>' +
    
    '<div style="border: 2px solid #000; margin-bottom: 20px;">' +
    '<div style="display: grid; grid-template-columns: 2fr 1fr 1fr; background: #f0f0f0; border-bottom: 2px solid #000;">' +
    '<div style="padding: 6px; border-right: 1px solid #000; font-weight: bold; font-size: 11px;">SK≈ÅADNIK</div>' +
    '<div style="padding: 6px; border-right: 1px solid #000; font-weight: bold; font-size: 11px; text-align: center;">GRAMY</div>' +
    '<div style="padding: 6px; font-weight: bold; font-size: 11px; text-align: center;">PROCENT</div>' +
    '</div>' +
    allRows +
    '</div>' +
    
    '<div style="border: 2px solid #000; margin-bottom: 20px;">' +
    '<div style="background: #f0f0f0; padding: 6px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11px;">UWAGI / WYKONANIE:</div>' +
    '<textarea id="recipe-notes" style="width: 100%; height: 60px; border: none; font-size: 11px; padding: 5px;" placeholder="Instrukcje wykonania..."></textarea>' +
    '</div>' +
    
    '<div style="padding: 10px; background: #e7f3ff; border: 1px solid #000; font-size: 11px;">' +
    '<strong>SUMA:</strong> <span id="total-grams">0</span>g | <strong>KOSZT:</strong> <span id="total-cost">0.00</span> z≈Ç' +
    '</div>' +
    
    '</div>';
}
function calculateAllPercentages() {
  var totalGrams = 0;
  var totalCost = 0;
  
  // Oblicz sumƒô gram√≥w
  for (var i = 0; i < 12; i++) {
    var gramsInput = document.getElementById('grams-' + i);
    if (gramsInput && gramsInput.value) {
      totalGrams += parseFloat(gramsInput.value) || 0;
    }
  }
  
  // Oblicz procenty i koszty
  for (var i = 0; i < 12; i++) {
    var gramsInput = document.getElementById('grams-' + i);
    var percentInput = document.getElementById('percent-' + i);
    var ingredientInput = document.getElementById('ingredient-' + i);
    
    if (gramsInput && percentInput && gramsInput.value) {
      var grams = parseFloat(gramsInput.value) || 0;
      var percent = totalGrams > 0 ? ((grams / totalGrams) * 100).toFixed(1) : 0;
      percentInput.value = percent + '%';
      
      // Oblicz koszt sk≈Çadnika
      if (ingredientInput && ingredientInput.value) {
        var ingredientName = ingredientInput.value.toLowerCase();
        var ingredientPrice = 0;
        
        // Znajd≈∫ sk≈Çadnik w bazie
        for (var j = 0; j < ingredients.length; j++) {
          var ing = ingredients[j];
          var name = (ing.name || ing.nazwa || ing.ingredient || '').toLowerCase();
          if (name.includes(ingredientName) || ingredientName.includes(name)) {
            ingredientPrice = ing.price || ing.cost || ing.cena || 0;
            break;
          }
        }
        
        var ingredientCost = (grams / 1000) * ingredientPrice; // koszt za kg
        totalCost += ingredientCost;
      }
    } else if (percentInput) {
      percentInput.value = '';
    }
  }
  
  // Aktualizuj podsumowanie
  document.getElementById('total-grams').textContent = totalGrams;
  document.getElementById('total-cost').textContent = totalCost.toFixed(2);
}
function loadRecipeData() {
  var recipeName = document.getElementById('recipe-name').value;
  var targetMass = parseFloat(document.getElementById('target-mass').value) || 1000;
  
  // Znajd≈∫ przepis
  var recipe = null;
  for (var i = 0; i < recipes.length; i++) {
    if (recipes[i].name.toLowerCase().includes(recipeName.toLowerCase())) {
      recipe = recipes[i];
      break;
    }
  }
  
  if (!recipe) {
    showNotification('Nie znaleziono przepisu!');
    return;
  }
  
  // Oblicz wsp√≥≈Çczynnik przeliczenia
  var originalMass = 0;
  for (var i = 0; i < recipe.ingredients.length; i++) {
    originalMass += parseFloat(recipe.ingredients[i].amount) || 0;
  }
  
  var multiplier = targetMass / originalMass;
  
  // Za≈Çaduj sk≈Çadniki
  for (var i = 0; i < recipe.ingredients.length && i < 12; i++) {
    var ingredient = recipe.ingredients[i];
    document.getElementById('ingredient-' + i).value = ingredient.name || ingredient.ingredient || '';
    document.getElementById('grams-' + i).value = Math.round((parseFloat(ingredient.amount) || 0) * multiplier);
  }
  
  // Za≈Çaduj uwagi
  document.getElementById('recipe-notes').value = recipe.instructions || '';
  
  // Przelicz procenty
  calculateAllPercentages();
  
  showNotification('Przepis za≈Çadowany i przeliczony!');
}
// Funkcja otwierania w nowej zak≈Çadce
function openRecipeInNewTab(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(generateRecipePrintHTML(recipe));
    printWindow.document.close();
}

// Funkcja drukowania
function printRecipe(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(generateRecipePrintHTML(recipe));
    printWindow.document.close();
    
    printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
    };
}

// Generator HTML do druku (identyczny z kalkulatorem)
function generateRecipePrintHTML(recipe) {
    const currentDate = new Date().toLocaleDateString('pl-PL');
    const currentTime = new Date().toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
    
    // Kalkulacja koszt√≥w
    let totalCost = 0;
    let totalWeight = 0;
    
    const ingredientsWithCosts = recipe.ingredients.map(recipeIng => {
        const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
        if (!ingredient) return null;
        
        const cost = (recipeIng.amount / 1000) * ingredient.pricePerKg;
        const weightPercent = (recipeIng.amount / recipe.ingredients.reduce((sum, ing) => sum + ing.amount, 0)) * 100;
        
        totalCost += cost;
        totalWeight += recipeIng.amount;
        
        return {
            name: ingredient.name,
            amount: recipeIng.amount,
            unit: ingredient.unit,
            weightPercent: weightPercent,
            cost: cost,
            allergen: ingredient.allergen
        };
    }).filter(item => item);
    
    // Sprawd≈∫ tagi dietetyczne
    const hasVege = recipe.tags?.includes('vege') || recipe.tags?.includes('wega≈Ñskie');
    const hasGlutenFree = recipe.tags?.includes('bezglutenowe');
    const hasVegan = recipe.tags?.includes('wega≈Ñskie');
    const hasLactoseFree = !ingredientsWithCosts.some(ing => ing.allergen === 'mleko');
    
    // Znajd≈∫ alergeny
    const allergens = [...new Set(ingredientsWithCosts
        .filter(ing => ing.allergen)
        .map(ing => ing.allergen))];
    
    return `
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Przepis: ${recipe.name}</title>
    <style>
        @page {
            margin: 20mm;
            size: A4;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #000;
            margin: 0;
            padding: 0;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 10px;
        }
        
        .company-info {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .company-name {
            font-size: 14px;
            font-weight: bold;
        }
        
        .recipe-title {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            text-transform: uppercase;
        }
        
        .info-sections {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .info-section {
            width: 48%;
        }
        
        .section-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .info-label {
            font-weight: bold;
        }
        
        .ingredients-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .ingredients-table th {
            background-color: #f0f0f0;
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
        }
        
        .ingredients-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            text-align: center;
            font-size: 11px;
        }
        
        .ingredients-table td:first-child {
            text-align: left;
        }
        
        .total-row {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .allergens-section,
        .instructions-section {
            margin: 20px 0;
            border: 1px solid #000;
            padding: 10px;
        }
        
        .instructions-section ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions-section li {
            margin-bottom: 5px;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            border-top: 1px solid #000;
            padding-top: 5px;
        }
        
        .tags-section {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }
        
        .tag {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background-color: #28a745;
            color: white;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .tag.gluten-free {
            background-color: #007bff;
        }
        
        .tag.vegan {
            background-color: #ffc107;
            color: #000;
        }
        
        .tag.lactose-free {
            background-color: #6f42c1;
        }
        
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>${currentDate}, ${currentTime}</div>
        <div>Karta Produktu - ${recipe.category || 'przepis'}</div>
    </div>
    
    <div class="company-info">
        <div class="company-name">CUKIERNIA PRO</div>
    </div>
    
    <div class="recipe-title">${recipe.name}</div>
    
    ${(hasVege || hasGlutenFree || hasVegan || hasLactoseFree) ? `
    <div class="tags-section">
        <div class="section-title">W≈Ça≈õciwo≈õci dietetyczne</div>
        ${hasVege ? '<span class="tag">üå± VEGE</span>' : ''}
        ${hasGlutenFree ? '<span class="tag gluten-free">üåæ BEZGLUTENOWE</span>' : ''}
        ${hasVegan ? '<span class="tag vegan">üåø WEGA≈ÉSKIE</span>' : ''}
        ${hasLactoseFree ? '<span class="tag lactose-free">ü•õ BEZ LAKTOZY</span>' : ''}
    </div>
    ` : ''}
    
    <div class="info-sections">
        <div class="info-section">
            <div class="section-title">Informacje podstawowe</div>
            <div class="info-row">
                <span class="info-label">Nazwa:</span>
                <span>${recipe.name}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Kategoria:</span>
                <span>${recipe.category || 'nie okre≈õlono'}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Ca≈Çkowita waga sk≈Çadnik√≥w:</span>
                <span>${totalWeight} g</span>
            </div>
            <div class="info-row">
                <span class="info-label">Wydajno≈õƒá:</span>
                <span>${recipe.servings || 'nie okre≈õlono'}</span>
            </div>
        </div>
        
        <div class="info-section">
            <div class="section-title">Kalkulacja koszt√≥w</div>
            <div class="info-row">
                <span class="info-label">Koszt sk≈Çadnik√≥w:</span>
                <span>${totalCost.toFixed(2)} z≈Ç</span>
            </div>
            <div class="info-row">
                <span class="info-label">Koszt po uwzglƒôdnieniu wydajno≈õci:</span>
                <span>${totalCost.toFixed(2)} z≈Ç</span>
            </div>
            <div class="info-row">
                <span class="info-label">Data:</span>
                <span>${currentDate}</span>
            </div>
        </div>
    </div>
    
    <table class="ingredients-table">
        <thead>
            <tr>
                <th>SK≈ÅADNIK</th>
                <th>ILO≈öƒÜ</th>
                <th>JEDNOSTKA</th>
                <th>UDZIA≈Å WAGOWY</th>
                <th>KOSZT</th>
            </tr>
        </thead>
        <tbody>
            ${ingredientsWithCosts.map(ing => `
                <tr>
                    <td>${ing.name}</td>
                    <td>${ing.amount}</td>
                    <td>${ing.unit}</td>
                    <td>${ing.weightPercent.toFixed(1)}%</td>
                    <td>${ing.cost.toFixed(2)} z≈Ç</td>
                </tr>
            `).join('')}
            <tr class="total-row">
                <td><strong>RAZEM</strong></td>
                <td><strong>${totalWeight}</strong></td>
                <td><strong>g</strong></td>
                <td><strong>100.0%</strong></td>
                <td><strong>${totalCost.toFixed(2)} z≈Ç</strong></td>
            </tr>
        </tbody>
    </table>
    
    <div class="allergens-section">
        <div class="section-title">Alergeny</div>
        <div class="info-row">
            <span class="info-label">Zawiera:</span>
            <span>${allergens.length > 0 ? allergens.join(', ') : 'brak'}</span>
        </div>
    </div>
    
    <div class="instructions-section">
        <div class="section-title">Instrukcje produkcji</div>
        ${recipe.instructions ? `
            <ol>
                ${recipe.instructions.split('\n').filter(step => step.trim()).map(step => 
                    `<li>${step.trim()}</li>`
                ).join('')}
            </ol>
        ` : '<p>Brak instrukcji</p>'}
    </div>
    
    <div class="footer">
        <div>Karta odpowiedzialnego</div>
        <div>Wygenerowano: ${currentDate}, ${currentTime}</div>
    </div>
    
    <div class="no-print" style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
        <button class="btn btn-print" onclick="printRecipe(RECIPE_ID)">
    <i class="fas fa-print"></i> Drukuj
</button>
<button class="btn btn-copy" onclick="openRecipeInNewTab(RECIPE_ID)">
    <i class="fas fa-external-link-alt"></i> Poka≈º
</button>
        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">‚úñÔ∏è Zamknij</button>
    </div>
</body>
</html>`;
}
function openRecipeInNewTab(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(generateRecipePrintHTML(recipe));
    printWindow.document.close();
}
function printRecipe(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(generateRecipePrintHTML(recipe));
    printWindow.document.close();
    
    setTimeout(() => {
        printWindow.print();
    }, 500);
}
function generateRecipePrintHTML(recipe) {
    const currentDate = new Date().toLocaleDateString('pl-PL');
    const currentTime = new Date().toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
    
    // Kalkulacja koszt√≥w
    let totalCost = 0;
    let totalWeight = 0;
    
    const ingredientsWithCosts = recipe.ingredients.map(recipeIng => {
        const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
        if (!ingredient) return null;
        
        const cost = (recipeIng.amount / 1000) * ingredient.pricePerKg;
        const weightPercent = (recipeIng.amount / recipe.ingredients.reduce((sum, ing) => sum + ing.amount, 0)) * 100;
        
        totalCost += cost;
        totalWeight += recipeIng.amount;
        
        return {
            name: ingredient.name,
            amount: recipeIng.amount,
            unit: ingredient.unit,
            weightPercent: weightPercent,
            cost: cost,
            allergen: ingredient.allergen
        };
    }).filter(item => item);
    
    // Sprawd≈∫ tagi dietetyczne
    const allergens = [...new Set(ingredientsWithCosts
        .filter(ing => ing.allergen)
        .map(ing => ing.allergen))];
    
    return `<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Przepis: ${recipe.name}</title>
    <style>
        @page { margin: 20mm; size: A4; }
        body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; color: #000; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 10px; }
        .company-info { text-align: center; margin-bottom: 30px; }
        .company-name { font-size: 14px; font-weight: bold; }
        .recipe-title { font-size: 16px; font-weight: bold; text-align: center; margin: 30px 0; text-transform: uppercase; }
        .info-sections { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .info-section { width: 48%; }
        .section-title { font-weight: bold; font-size: 13px; margin-bottom: 10px; text-transform: uppercase; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 2px 0; }
        .info-label { font-weight: bold; }
        .ingredients-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .ingredients-table th { background-color: #f0f0f0; border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 11px; }
        .ingredients-table td { border: 1px solid #000; padding: 6px 8px; text-align: center; font-size: 11px; }
        .ingredients-table td:first-child { text-align: left; }
        .total-row { background-color: #f0f0f0; font-weight: bold; }
        .allergens-section, .instructions-section { margin: 20px 0; border: 1px solid #000; padding: 10px; }
        .instructions-section ol { margin: 10px 0; padding-left: 20px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; text-align: center; font-size: 10px; border-top: 1px solid #000; padding-top: 5px; }
        .no-print { position: fixed; top: 10px; right: 10px; z-index: 1000; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <div>${currentDate}, ${currentTime}</div>
        <div>Karta Produktu - ${recipe.category || 'przepis'}</div>
    </div>
    
    <div class="company-info">
        <div class="company-name">CUKIERNIA PRO</div>
    </div>
    
    <div class="recipe-title">${recipe.name}</div>
    
    <div class="info-sections">
        <div class="info-section">
            <div class="section-title">Informacje podstawowe</div>
            <div class="info-row"><span class="info-label">Nazwa:</span><span>${recipe.name}</span></div>
            <div class="info-row"><span class="info-label">Kategoria:</span><span>${recipe.category || 'nie okre≈õlono'}</span></div>
            <div class="info-row"><span class="info-label">Ca≈Çkowita waga sk≈Çadnik√≥w:</span><span>${totalWeight} g</span></div>
            <div class="info-row"><span class="info-label">Wydajno≈õƒá:</span><span>${recipe.servings || 'nie okre≈õlono'}</span></div>
        </div>
        
        <div class="info-section">
            <div class="section-title">Kalkulacja koszt√≥w</div>
            <div class="info-row"><span class="info-label">Koszt sk≈Çadnik√≥w:</span><span>${totalCost.toFixed(2)} z≈Ç</span></div>
            <div class="info-row"><span class="info-label">Koszt po uwzglƒôdnieniu wydajno≈õci:</span><span>${totalCost.toFixed(2)} z≈Ç</span></div>
            <div class="info-row"><span class="info-label">Data:</span><span>${currentDate}</span></div>
        </div>
    </div>
    
    <table class="ingredients-table">
        <thead>
            <tr>
                <th>SK≈ÅADNIK</th>
                <th>ILO≈öƒÜ</th>
                <th>JEDNOSTKA</th>
                <th>UDZIA≈Å WAGOWY</th>
                <th>KOSZT</th>
            </tr>
        </thead>
        <tbody>
            ${ingredientsWithCosts.map(ing => `
                <tr>
                    <td>${ing.name}</td>
                    <td>${ing.amount}</td>
                    <td>${ing.unit}</td>
                    <td>${ing.weightPercent.toFixed(1)}%</td>
                    <td>${ing.cost.toFixed(2)} z≈Ç</td>
                </tr>
            `).join('')}
            <tr class="total-row">
                <td><strong>RAZEM</strong></td>
                <td><strong>${totalWeight}</strong></td>
                <td><strong>g</strong></td>
                <td><strong>100.0%</strong></td>
                <td><strong>${totalCost.toFixed(2)} z≈Ç</strong></td>
            </tr>
        </tbody>
    </table>
    
    <div class="allergens-section">
        <div class="section-title">Alergeny</div>
        <div class="info-row">
            <span class="info-label">Zawiera:</span>
            <span>${allergens.length > 0 ? allergens.join(', ') : 'brak'}</span>
        </div>
    </div>
    
    <div class="instructions-section">
        <div class="section-title">Instrukcje produkcji</div>
        ${recipe.instructions ? `
            <ol>
                ${recipe.instructions.split('\\n').filter(step => step.trim()).map(step => 
                    `<li>${step.trim()}</li>`
                ).join('')}
            </ol>
        ` : '<p>Brak instrukcji</p>'}
    </div>
    
    <div class="footer">
        <div>Karta odpowiedzialnego</div>
        <div>Wygenerowano: ${currentDate}, ${currentTime}</div>
    </div>
    
    <div class="no-print">
        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">üñ®Ô∏è Drukuj</button>
        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">‚úñÔ∏è Zamknij</button>
    </div>
</body>
</html>`;
}
// Kalkulator objƒôto≈õci form
document.addEventListener('DOMContentLoaded', function() {
    // Event listenery dla wszystkich p√≥l
    const inputs = [
        'circle-diameter', 'circle-height',
        'rect-length', 'rect-width', 'rect-height',
        'square-side', 'square-height',
        'base-diameter', 'base-height'
    ];
    
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', calculateVolumes);
        }
    });
});

function calculateVolumes() {
    calculateCircleVolume();
    calculateRectVolume();
    calculateSquareVolume();
    calculateComparison();
}

function calculateCircleVolume() {
    const diameter = parseFloat(document.getElementById('circle-diameter')?.value) || 0;
    const height = parseFloat(document.getElementById('circle-height')?.value) || 0;
    
    if (diameter > 0 && height > 0) {
        const radius = diameter / 2;
        const volume = Math.PI * radius * radius * height; // cm¬≥
        const volumeMl = volume; // 1 cm¬≥ = 1 ml
        
        document.getElementById('circle-result').textContent = `${Math.round(volumeMl)} ml`;
    } else {
        document.getElementById('circle-result').textContent = '0 ml';
    }
}

function calculateRectVolume() {
    const length = parseFloat(document.getElementById('rect-length')?.value) || 0;
    const width = parseFloat(document.getElementById('rect-width')?.value) || 0;
    const height = parseFloat(document.getElementById('rect-height')?.value) || 0;
    
    if (length > 0 && width > 0 && height > 0) {
        const volume = length * width * height; // cm¬≥
        const volumeMl = volume; // 1 cm¬≥ = 1 ml
        
        document.getElementById('rect-result').textContent = `${Math.round(volumeMl)} ml`;
    } else {
        document.getElementById('rect-result').textContent = '0 ml';
    }
}

function calculateSquareVolume() {
    const side = parseFloat(document.getElementById('square-side')?.value) || 0;
    const height = parseFloat(document.getElementById('square-height')?.value) || 0;
    
    if (side > 0 && height > 0) {
        const volume = side * side * height; // cm¬≥
        const volumeMl = volume; // 1 cm¬≥ = 1 ml
        
        document.getElementById('square-result').textContent = `${Math.round(volumeMl)} ml`;
    } else {
        document.getElementById('square-result').textContent = '0 ml';
    }
}

function calculateComparison() {
    const baseDiameter = parseFloat(document.getElementById('base-diameter')?.value) || 0;
    const baseHeight = parseFloat(document.getElementById('base-height')?.value) || 0;
    
    if (baseDiameter > 0 && baseHeight > 0) {
        const baseRadius = baseDiameter / 2;
        const baseVolume = Math.PI * baseRadius * baseRadius * baseHeight;
        
        document.getElementById('base-volume').textContent = `${Math.round(baseVolume)} ml`;
        
        // Por√≥wnaj z aktualnie wybranƒÖ formƒÖ (okrƒÖg≈ÇƒÖ)
        const currentDiameter = parseFloat(document.getElementById('circle-diameter')?.value) || 0;
        const currentHeight = parseFloat(document.getElementById('circle-height')?.value) || 0;
        
        if (currentDiameter > 0 && currentHeight > 0) {
            const currentRadius = currentDiameter / 2;
            const currentVolume = Math.PI * currentRadius * currentRadius * currentHeight;
            
            const difference = currentVolume - baseVolume;
            const multiplier = currentVolume / baseVolume;
            
            document.getElementById('volume-difference').textContent = `${Math.round(difference)} ml`;
            document.getElementById('volume-multiplier').textContent = `${multiplier.toFixed(2)}x`;
        }
    } else {
        document.getElementById('base-volume').textContent = '0 ml';
        document.getElementById('volume-difference').textContent = '0 ml';
        document.getElementById('volume-multiplier').textContent = '1.0x';
    }
}
// Eksport przepisu do CSV
function exportRecipeToCSV(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    // Nag≈Ç√≥wek CSV
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "PRZEPIS: " + recipe.name + "\n";
    csvContent += "KATEGORIA: " + (recipe.category || 'brak') + "\n";
    csvContent += "WYDAJNO≈öƒÜ: " + (recipe.servings || 'brak') + "\n";
    csvContent += "OPIS: " + (recipe.description || 'brak') + "\n\n";
    
    // Nag≈Ç√≥wki tabeli sk≈Çadnik√≥w
    csvContent += "SK≈ÅADNIK,ILO≈öƒÜ,JEDNOSTKA,CENA ZA JEDNOSTKƒò,KOSZT SK≈ÅADNIKA,UDZIA≈Å WAGOWY,ALERGEN\n";
    
    // Oblicz dane
    let totalCost = 0;
    let totalWeight = 0;
    
    const ingredientsData = recipe.ingredients.map(recipeIng => {
        const ingredient = ingredients.find(ing => ing.id === recipeIng.ingredientId);
        if (!ingredient) return null;
        
        const cost = (recipeIng.amount / 1000) * ingredient.pricePerKg;
        totalCost += cost;
        totalWeight += recipeIng.amount;
        
        return {
            name: ingredient.name,
            amount: recipeIng.amount,
            unit: ingredient.unit,
            pricePerKg: ingredient.pricePerKg,
            cost: cost,
            allergen: ingredient.allergen || 'brak'
        };
    }).filter(item => item);
    
    // Dodaj sk≈Çadniki
    ingredientsData.forEach(ing => {
        const weightPercent = (ing.amount / totalWeight * 100).toFixed(1);
        csvContent += `"${ing.name}",${ing.amount},${ing.unit},${ing.pricePerKg.toFixed(2)},${ing.cost.toFixed(2)},${weightPercent}%,"${ing.allergen}"\n`;
    });
    
    // Podsumowanie
    csvContent += `"RAZEM",${totalWeight},g,,${totalCost.toFixed(2)},100.0%,\n\n`;
    
    // Instrukcje
    if (recipe.instructions) {
        csvContent += "INSTRUKCJE PRODUKCJI:\n";
        const steps = recipe.instructions.split('\n').filter(step => step.trim());
        steps.forEach((step, index) => {
            csvContent += `"${index + 1}. ${step.trim()}"\n`;
        });
    }
    
    // Pobierz plik
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `przepis_${recipe.name.replace(/[^a-z0-9]/gi, '_')}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`üìÑ Przepis "${recipe.name}" zosta≈Ç wyeksportowany do CSV!`);
}
// Eksport przepisu do PDF (w formie HTML z mo≈ºliwo≈õciƒÖ zapisu jako PDF)
function exportRecipeToPDF(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(generateRecipePrintHTML(recipe));
    printWindow.document.close();
    
    // Po za≈Çadowaniu - poka≈º opcje
    printWindow.onload = function() {
        // Dodaj dodatkowe przyciski
        const extraButtons = printWindow.document.createElement('div');
        extraButtons.innerHTML = `
            <div style="position: fixed; top: 50px; right: 10px; z-index: 1001; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                <div style="margin-bottom: 10px; font-weight: bold;">Opcje eksportu:</div>
                <button onclick="window.print()" style="display: block; width: 100%; margin-bottom: 5px; padding: 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">üñ®Ô∏è Drukuj</button>
                <button onclick="saveToPDF()" style="display: block; width: 100%; margin-bottom: 5px; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">üìÑ Zapisz PDF</button>
                <button onclick="window.close()" style="display: block; width: 100%; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">‚ùå Zamknij</button>
            </div>
        `;
        
        printWindow.document.body.appendChild(extraButtons);
        
        // Funkcja zapisu PDF
        printWindow.saveToPDF = function() {
            printWindow.print();
            setTimeout(() => {
                alert('Instrukcja:\n1. W oknie druku wybierz "Zapisz jako PDF"\n2. Kliknij "Zapisz"\n3. Wybierz lokalizacjƒô pliku');
            }, 500);
        };
    };
    
    showNotification(`üìÑ Otwarto przepis "${recipe.name}" w trybie eksportu PDF!`);
}
// Eksport z zaawansowanymi opcjami
function exportRecipeAdvanced(recipeId) {
    const recipe = recipes.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 10000; padding: 20px; box-sizing: border-box;
    `;
    
    modal.innerHTML = `
        <div style="background: var(--card-bg); border-radius: 12px; padding: 30px; max-width: 400px; width: 100%;">
            <h3 style="margin: 0 0 20px 0; color: var(--primary-color); text-align: center;">
                üì§ Eksport Przepisu<br><small>"${recipe.name}"</small>
            </h3>
            
            <div style="margin-bottom: 20px;">
                <button onclick="exportRecipeToCSV(${recipeId}); closeModal()" class="btn" style="width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üìä Eksport do CSV
                    <small style="opacity: 0.7;">(Excel, Google Sheets)</small>
                </button>
                
                <button onclick="exportRecipeToPDF(${recipeId}); closeModal()" class="btn" style="width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üìÑ Eksport do PDF
                    <small style="opacity: 0.7;">(druk, archiwum)</small>
                </button>
                
                <button onclick="printRecipe(${recipeId}); closeModal()" class="btn" style="width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    üñ®Ô∏è Drukuj bezpo≈õrednio
                </button>
            </div>
            
            <div style="text-align: center;">
                <button onclick="closeModal()" class="btn btn-secondary">‚ùå Anuluj</button>
            </div>
        </div>
    `;
    
    // Dodaj funkcjƒô zamykania
    window.closeModal = function() {
        modal.remove();
        delete window.closeModal;
    };
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            window.closeModal();
        }
    });
    
    document.body.appendChild(modal);
}



  </script>
  <div class="pro-interface" style="display: none;">
  <div class="pro-header">
    üìä CUKIERNIA PRO - ARKUSZ KALKULACYJNY
    <button onclick="toggleProMode()" style="float: right; background: #dc3545; color: white; border: none; padding: 8px 15px;">üé® Tryb Standard</button>
  </div>
  
  <div class="pro-tabs">
    <button class="pro-tab active" onclick="showProTab('recipes')">üìã PRZEPISY</button>
    <button class="pro-tab" onclick="showProTab('ingredients')">ü•Ñ SK≈ÅADNIKI</button>
    <button class="pro-tab" onclick="showProTab('calculator')">üßÆ KALKULATOR</button>
  </div>
  
  <div class="pro-content" id="pro-content">
    <h2>TRYB PRO</h2>
    <p>Wybierz zak≈Çadkƒô powy≈ºej...</p>
  </div>
</div>
</body>
</html>